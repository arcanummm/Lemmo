

===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\Commands\Auth\Login\LoginCommand.cs =====

using MediatR;

namespace Lemmo.WebApi.Application.Commands.Auth.Login
{
    public record LoginCommand(string PhoneNumber, string Password, string? Device) : IRequest<AuthResponse>;
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\Commands\Auth\Login\LoginCommandHandler.cs =====

using Lemmo.WebApi.Persistance.Auth.Interfaces;
using MediatR;

namespace Lemmo.WebApi.Application.Commands.Auth.Login
{
    public class LoginCommandHandler(IAuthManager authManager) : IRequestHandler<LoginCommand, AuthResponse>
    {
        public async Task<AuthResponse> Handle(LoginCommand request, CancellationToken ct)
        {
            var result = await authManager.Login(request.PhoneNumber, request.Password, request.Device, ct);

            if(result.IsSuccessful)
            {
                return new AuthResponse(result.AccessToken!, result.RefreshToken!);
            }

            return new AuthResponse("", "");
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\Commands\Auth\Login\LoginCommandValidator.cs =====

using FluentValidation;

namespace Lemmo.WebApi.Application.Commands.Auth.Login
{
    public class LoginCommandValidator : AbstractValidator<LoginCommand>
    {
        public LoginCommandValidator()
        {
            RuleFor(x => x.PhoneNumber)
                .NotEmpty()
                .MinimumLength(12);

            RuleFor(x => x.Password)
                .NotEmpty()
                .MinimumLength(6);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\Commands\Auth\AuthResponse.cs =====

namespace Lemmo.WebApi.Application.Commands.Auth
{
    public record AuthResponse(string AccessToken, string RefreshToken);
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\AppExtentions.cs =====

using FluentValidation;
using MediatR;
using System.Reflection;

namespace Lemmo.WebApi.Application
{
    public static class AppExtentions
    {
        public static IServiceCollection AddMediator(this IServiceCollection services)
        {
            services.AddMediatR(cfg => cfg.RegisterServicesFromAssembly(Assembly.GetExecutingAssembly()));

            services.AddValidatorsFromAssembly(Assembly.GetExecutingAssembly());

            services.AddTransient(typeof(IPipelineBehavior<,>), typeof(ValidationBehavior<,>));

            return services;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Application\ValidationBehavior.cs =====

using FluentValidation;
using MediatR;

namespace Lemmo.WebApi.Application
{
    public class ValidationBehavior<TRequest, TResponse>(IEnumerable<IValidator<TRequest>> validators)
     : IPipelineBehavior<TRequest, TResponse> where TRequest : notnull
    {
        public async Task<TResponse> Handle(TRequest request, RequestHandlerDelegate<TResponse> next, CancellationToken cancellationToken)
        {
            if (validators.Any())
            {
                var context = new ValidationContext<TRequest>(request);

                var failures = (await Task.WhenAll(
                        validators.Select(v =>
                            v.ValidateAsync(context, cancellationToken))))
                    .SelectMany(r => r.Errors)
                    .Where(f => f != null)
                    .ToList();

                if (failures.Count != 0)
                    throw new FluentValidation.ValidationException(failures);
            }

            return await next();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Controllers\AuthController.cs =====

using Lemmo.WebApi.Application.Commands.Auth.Login;
using Lemmo.WebApi.Dtos;
using MediatR;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

namespace Lemmo.WebApi.Controllers
{
    [Route("api/auth")]
    [ApiController]
    public class AuthController(IMediator mediator) : ControllerBase
    {
        [AllowAnonymous]
        [HttpPost("login")]
        public async Task<IActionResult> Login(LoginDto dto, [FromHeader(Name = "User-Agent")] string? device)
        {
            var result = await mediator.Send(new LoginCommand(dto.PhoneNumber, dto.Password, device));

            return Ok(result);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Dtos\LoginDto.cs =====

namespace Lemmo.WebApi.Dtos
{
    public record LoginDto(string PhoneNumber, string Password);

}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Common\EntityBase.cs =====

namespace Lemmo.WebApi.Entitys.Common
{
    public class EntityBase
    {
        public Guid Id { get; set; }

        public DateTimeOffset CreatedAt { get; set; }

        public DateTimeOffset UpdatedAt { get; set; }

        public bool IsDeleted { get; set; }
    }
}





===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Enums\ExceptionType.cs =====

namespace Lemmo.WebApi.Entitys.Enums
{
    public enum ExceptionType
    {
        Cancelled,      // Урок отменен
        Rescheduled,    // Урок перенесен на другое время
        PriceChanged,   // Изменена цена (сохраняем как отдельный урок)
        Other           // Другое изменение
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Enums\LessonStatus.cs =====

namespace Lemmo.WebApi.Entitys.Enums
{
    public enum LessonStatus
    {
        Planned,     // Только в шаблоне
        Completed,   // Фактически проведен
        Cancelled    // Отменен
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Enums\MonthlyRecurrenceType.cs =====

namespace Lemmo.WebApi.Entitys.Enums
{
    public enum MonthlyRecurrenceType
    {
        DayOfMonth,     // Каждое 15 число
        DayOfWeek       // Каждый первый понедельник
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Enums\PersonalEventExceptionType.cs =====

namespace Lemmo.WebApi.Entitys.Enums
{
    public enum PersonalEventExceptionType
    {
        Cancelled,
        Rescheduled,
        Other
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Enums\RecurrenceType.cs =====

namespace Lemmo.WebApi.Entitys.Enums
{
    public enum RecurrenceType
    {
        Daily,
        Weekly,
        Monthly
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Students\Student.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys.Students
{
    // Ученик (без изменений)
    public class Student : EntityBase
    {
        public string Name { get; set; } = string.Empty;
        public string? Notes { get; set; }
        public Guid UserId { get; set; }
        public User User { get; set; } = null!;
        public ICollection<StudentContact> Contacts { get; set; } = [];
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Students\StudentContact.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys.Students
{
    public class StudentContact : EntityBase
    {
        public Guid StudentId { get; set; }
        public Student Student { get; set; } = null!;
        public string Value { get; set; } = string.Empty;
        public string Type { get; set; } = string.Empty;
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\TelegramSessions\Enums\RegistrationState.cs =====

namespace Lemmo.WebApi.Entitys.TelegramSessions.Enums
{
    public enum RegistrationState
    {
        None,
        WaitingForPhone,
        WaitingForPassword
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\TelegramSessions\Interfaces\ITelegramSessionsRepository.cs =====

namespace Lemmo.WebApi.Entitys.TelegramSessions.Interfaces
{
    public interface ITelegramSessionsRepository
    {
        Task<TelegramUserSession?> GetByTelegramIdAsync(long telegramId, CancellationToken cancellationToken = default);
        Task DeleteByTelegramIdAsync(long telegramId, CancellationToken cancellationToken = default);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\TelegramSessions\TelegramUserSession.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.TelegramSessions.Enums;

namespace Lemmo.WebApi.Entitys.TelegramSessions
{
    public class TelegramUserSession : EntityBase
    {
        public long TelegramUserId { get; set; }
        public string? PhoneNumber { get; set; }
        public RegistrationState State { get; set; } = RegistrationState.None;
        public DateTime LastActivity { get; set; } = DateTime.UtcNow;
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\DefaultRoomSettings.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // Настройки комнаты по умолчанию
    public class DefaultRoomSettings : EntityBase
    {
        public Guid RoomId { get; set; }
        public Room Room { get; set; } = null!;
        public double DefaultPricePerHour { get; set; }
        public TimeSpan DefaultDuration { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\DefaultUserLessonSettings.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    public class DefaultUserLessonSettings : EntityBase
    {
        public Guid UserId { get; set; }
        public User User { get; set; } = null!;
        public double DefaultPricePerHour { get; set; } = 300;
        public TimeSpan DefaultDuration { get; set; } = TimeSpan.FromHours(1);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Homework.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    public class Homework : EntityBase
    {
        public Guid RoomId { get; set; }
        public Room Room { get; set; } = null!;
        public string FileUrl { get; set; } = string.Empty;
        public DateTimeOffset Deadline { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Lesson.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Enums;

namespace Lemmo.WebApi.Entitys
{
    // Фактический проведенный урок
    public class Lesson : EntityBase
    {
        public Guid RoomId { get; set; }
        public Room Room { get; set; } = null!;
        public Guid? TemplateId { get; set; }
        public RoomScheduleTemplate? Template { get; set; }
        public Guid? TemplateRuleId { get; set; }
        public ScheduleTemplateRule? TemplateRule { get; set; }

        public DateTimeOffset StartTime { get; set; }
        public TimeSpan Duration { get; set; }
        public double Price { get; set; }

        public LessonStatus Status { get; set; } = LessonStatus.Completed; // Все сохраненные уроки - завершенные
        public string? Notes { get; set; }

        // Если урок перенесен/отменен из шаблона
        public bool IsModified { get; set; } // Изменен ли относительно шаблона
        public DateTimeOffset? OriginalPlannedTime { get; set; } // Когда должен был быть по шаблону
        public string? ModificationReason { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Note.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    public class Note : EntityBase
    {
        public Guid RoomId { get; set; }
        public Room Room { get; set; } = null!;
        public string FileUrl { get; set; } = string.Empty;
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\PersonalEvent.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // ЛИЧНЫЕ СОБЫТИЯ УЧИТЕЛЯ
    public class PersonalEvent : EntityBase
    {
        public Guid UserId { get; set; }
        public User User { get; set; } = null!;

        public DateTimeOffset StartTime { get; set; }
        public DateTimeOffset EndTime { get; set; }

        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? Location { get; set; }

        // Для повторяющихся событий
        public bool IsFromTemplate { get; set; }
        public Guid? TemplateId { get; set; }
        public PersonalEventTemplate? Template { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\PersonalEventException.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Enums;

namespace Lemmo.WebApi.Entitys
{
    // ИСКЛЮЧЕНИЯ ДЛЯ ЛИЧНЫХ СОБЫТИЙ
    public class PersonalEventException : EntityBase
    {
        public Guid TemplateId { get; set; }
        public PersonalEventTemplate Template { get; set; } = null!;

        public DateTimeOffset ExceptionDate { get; set; }
        public PersonalEventExceptionType Type { get; set; }

        // Для переноса
        public DateTimeOffset? NewDateTime { get; set; }
        public TimeSpan? NewDuration { get; set; }

        public string Reason { get; set; } = string.Empty;

        // Ссылка на созданное событие
        public Guid? CreatedEventId { get; set; }
        public PersonalEvent? CreatedEvent { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\PersonalEventTemplate.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // ШАБЛОН ПОВТОРЯЮЩИХСЯ ЛИЧНЫХ СОБЫТИЙ
    public class PersonalEventTemplate : EntityBase
    {
        public Guid UserId { get; set; }
        public User User { get; set; } = null!;

        public string Title { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string? Location { get; set; }

        public TimeSpan Duration { get; set; }

        // Правила повторения
        public RecurrencePattern RecurrencePattern { get; set; } = null!;
        public DateOnly ValidFrom { get; set; }
        public DateOnly? ValidUntil { get; set; }

        public ICollection<PersonalEventException> Exceptions { get; set; } = new List<PersonalEventException>();
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\PreRegistrModel.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    public class PreRegistrModel : EntityBase
    {
        public long TelegramId { get; set; }
        public string PhoneNumber { get; set; } 
        public string? PasswordHash { get; set; } 
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\RecurrencePattern.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Enums;

namespace Lemmo.WebApi.Entitys
{
    // ПРАВИЛО ПОВТОРЕНИЯ ДЛЯ ЛИЧНЫХ СОБЫТИЙ
    public class RecurrencePattern : EntityBase
    {
        public Guid TemplateId { get; set; }
        public PersonalEventTemplate Template { get; set; } = null!;

        public RecurrenceType Type { get; set; }
        public int Interval { get; set; } = 1;

        // Для Weekly
        public List<DayOfWeek> DaysOfWeek { get; set; } = new List<DayOfWeek>();

        // Для Monthly
        public int? DayOfMonth { get; set; }
        public MonthlyRecurrenceType? MonthlyType { get; set; } // DayOfMonth или DayOfWeek

        // Ограничения
        public DateTimeOffset? EndDate { get; set; }
        public int? OccurrenceCount { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\RefreshToken.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    public class RefreshToken : EntityBase
    {
        public string TokenHash { get; set; } = null!;
        public DateTime ExpiresAt { get; set; }

        public bool IsRevoked { get; set; } = false;
        public DateTime? RevokedAt { get; set; }

        public Guid UserId { get; set; } 
        public User User { get; set; } 

        public string Device { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\Room.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Students;

namespace Lemmo.WebApi.Entitys
{
    // Комната (Ученик)
    public class Room : EntityBase
    {
        public Guid StudentId { get; set; }
        public Student Student { get; set; } = null!;
        public Guid OwnerId { get; set; }
        public User Owner { get; set; } = null!;

        public ICollection<Homework> Homeworks { get; set; } = [];
        public ICollection<Note> Notes { get; set; } = [];
        public ICollection<Lesson> Lessons { get; set; } = []; // Только фактические уроки
        public RoomScheduleTemplate? ScheduleTemplate { get; set; } // Шаблон повторяющихся уроков
        public DefaultRoomSettings DefaultSettings { get; set; } = null!; // Настройки по умолчанию
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\RoomScheduleTemplate.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // ШАБЛОН ПОВТОРЯЮЩИХСЯ УРОКОВ ДЛЯ КОМНАТЫ
    public class RoomScheduleTemplate : EntityBase
    {
        public Guid RoomId { get; set; }
        public Room Room { get; set; } = null!;

        public string? Name { get; set; }
        public DateOnly ValidFrom { get; set; }
        public DateOnly? ValidUntil { get; set; }

        public ICollection<ScheduleTemplateRule> Rules { get; set; } = [];
        public ICollection<ScheduleException> Exceptions { get; set; } = [];
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\ScheduleException.cs =====

using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Enums;

namespace Lemmo.WebApi.Entitys
{
    // ИСКЛЮЧЕНИЯ В ШАБЛОНЕ (отмена/перенос)
    public class ScheduleException : EntityBase
    {
        public Guid TemplateId { get; set; }
        public RoomScheduleTemplate Template { get; set; } = null!;

        public DateOnly ExceptionDate { get; set; }
        public ExceptionType Type { get; set; }

        // Для переноса
        public DateTimeOffset? NewDateTime { get; set; }
        public TimeSpan? NewDuration { get; set; }
        public double? NewPrice { get; set; }

        // Причина
        public string Reason { get; set; } = string.Empty;

        // Ссылка на созданный урок (если перенесен)
        public Guid? CreatedLessonId { get; set; }
        public Lesson? CreatedLesson { get; set; }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\ScheduleTemplateRule.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // Правило в шаблоне (день+время)
    public class ScheduleTemplateRule : EntityBase
    {
        public Guid TemplateId { get; set; }
        public RoomScheduleTemplate Template { get; set; } = null!;

        public DayOfWeek DayOfWeek { get; set; }
        public TimeOnly StartTime { get; set; }
        public TimeSpan Duration { get; set; }
        public double Price { get; set; }

        // Можно отключить отдельное правило без удаления
        public bool IsActive { get; set; } = true;
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Entitys\User.cs =====

using Lemmo.WebApi.Entitys.Common;

namespace Lemmo.WebApi.Entitys
{
    // Пользователь (Учитель)
    public class User : EntityBase
    {
        public long TelegramId { get; set; }

        public string? FirstName { get; set; }

        public string? LastName { get; set; }

        public string PasswordHash { get; set; } = string.Empty;

        public string PhoneNumber { get; set; } = string.Empty;

        public ICollection<Room> Rooms { get; set; } = [];

        public DefaultUserLessonSettings DefaultLessonSettings { get; set; } = new();

        public ICollection<PersonalEventTemplate> PersonalEventTemplates { get; set; } = [];

        public ICollection<RefreshToken> RefreshTokens { get; set; } = [];
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\Comparers\DateOnlyComparer.cs =====

using Microsoft.EntityFrameworkCore.ChangeTracking;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers
{
    public class DateOnlyComparer : ValueComparer<DateOnly>
    {
        public DateOnlyComparer() : base(
            (d1, d2) => d1 == d2,
            d => d.GetHashCode())
        {
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\Comparers\TimeOnlyComparer.cs =====

using Microsoft.EntityFrameworkCore.ChangeTracking;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers
{
    public class TimeOnlyComparer : ValueComparer<TimeOnly>
    {
        public TimeOnlyComparer() : base(
            (t1, t2) => t1 == t2,
            t => t.GetHashCode())
        {
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\Converters\DateOnlyConverter.cs =====

using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations.Converters
{
    public class DateOnlyConverter : ValueConverter<DateOnly, DateTime>
    {
        public DateOnlyConverter() : base(
            dateOnly => dateOnly.ToDateTime(TimeOnly.MinValue),
            dateTime => DateOnly.FromDateTime(dateTime))
        {
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\Converters\TimeOnlyConverter.cs =====

using Microsoft.EntityFrameworkCore.Storage.ValueConversion;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations.Converters
{
    public class TimeOnlyConverter : ValueConverter<TimeOnly, TimeSpan>
    {
        public TimeOnlyConverter() : base(
            timeOnly => timeOnly.ToTimeSpan(),
            timeSpan => TimeOnly.FromTimeSpan(timeSpan))
        {
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\DefaultRoomSettingsConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class DefaultRoomSettingsConfiguration : IEntityTypeConfiguration<DefaultRoomSettings>
    {
        public void Configure(EntityTypeBuilder<DefaultRoomSettings> builder)
        {
            builder.ToTable("default_room_settings");

            builder.HasKey(drs => drs.Id);
            builder.Property(drs => drs.Id).ValueGeneratedOnAdd();

            builder.Property(drs => drs.DefaultPricePerHour)
                .IsRequired()
                .HasColumnType("decimal(10,2)");

            builder.Property(drs => drs.DefaultDuration)
                .IsRequired()
                .HasColumnType("interval");

            // Связи
            builder.HasOne(drs => drs.Room)
                .WithOne(r => r.DefaultSettings)
                .HasForeignKey<DefaultRoomSettings>(drs => drs.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(drs => drs.RoomId).IsUnique();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\DefaultUserLessonSettingsConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class DefaultUserLessonSettingsConfiguration : IEntityTypeConfiguration<DefaultUserLessonSettings>
    {
        public void Configure(EntityTypeBuilder<DefaultUserLessonSettings> builder)
        {
            builder.ToTable("default_user_lesson_settings");

            builder.HasKey(dus => dus.Id);
            builder.Property(dus => dus.Id).ValueGeneratedOnAdd();

            builder.Property(dus => dus.DefaultPricePerHour)
                .IsRequired()
                .HasColumnType("decimal(10,2)");

            builder.Property(dus => dus.DefaultDuration)
                .IsRequired()
                .HasColumnType("interval");

            // Связи
            builder.HasOne(dus => dus.User)
                .WithOne(u => u.DefaultLessonSettings)
                .HasForeignKey<DefaultUserLessonSettings>(dus => dus.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(dus => dus.UserId).IsUnique();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\HomeworkConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class HomeworkConfiguration : IEntityTypeConfiguration<Homework>
    {
        public void Configure(EntityTypeBuilder<Homework> builder)
        {
            builder.ToTable("homeworks");

            builder.HasKey(h => h.Id);
            builder.Property(h => h.Id).ValueGeneratedOnAdd();

            builder.Property(h => h.FileUrl)
                .IsRequired()
                .HasMaxLength(500);

            builder.Property(h => h.Deadline)
                .IsRequired();

            // Связи
            builder.HasOne(h => h.Room)
                .WithMany(r => r.Homeworks)
                .HasForeignKey(h => h.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(h => h.RoomId);
            builder.HasIndex(h => h.Deadline);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\LessonConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class LessonConfiguration : IEntityTypeConfiguration<Lesson>
    {
        public void Configure(EntityTypeBuilder<Lesson> builder)
        {
            builder.ToTable("lessons");

            builder.HasKey(l => l.Id);
            builder.Property(l => l.Id).ValueGeneratedOnAdd();

            builder.Property(l => l.StartTime)
                .IsRequired();

            builder.Property(l => l.Duration)
                .IsRequired()
                .HasColumnType("interval");

            builder.Property(l => l.Price)
                .IsRequired()
                .HasColumnType("decimal(10,2)");

            builder.Property(l => l.Status)
                .IsRequired()
                .HasConversion<string>()
                .HasMaxLength(20);

            builder.Property(l => l.Notes)
                .HasMaxLength(2000);

            builder.Property(l => l.ModificationReason)
                .HasMaxLength(500);

            // Связи
            builder.HasOne(l => l.Room)
                .WithMany(r => r.Lessons)
                .HasForeignKey(l => l.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(l => l.Template)
                .WithMany()
                .HasForeignKey(l => l.TemplateId)
                .OnDelete(DeleteBehavior.SetNull);

            builder.HasOne(l => l.TemplateRule)
                .WithMany()
                .HasForeignKey(l => l.TemplateRuleId)
                .OnDelete(DeleteBehavior.SetNull);

            // Индексы
            builder.HasIndex(l => l.RoomId);
            builder.HasIndex(l => l.StartTime);
            builder.HasIndex(l => l.Status);
            builder.HasIndex(l => new { l.RoomId, l.StartTime });
            builder.HasIndex(l => l.TemplateId);
            builder.HasIndex(l => l.OriginalPlannedTime);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\NoteConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class NoteConfiguration : IEntityTypeConfiguration<Note>
    {
        public void Configure(EntityTypeBuilder<Note> builder)
        {
            builder.ToTable("notes");

            builder.HasKey(n => n.Id);
            builder.Property(n => n.Id).ValueGeneratedOnAdd();

            builder.Property(n => n.FileUrl)
                .IsRequired()
                .HasMaxLength(500);

            // Связи
            builder.HasOne(n => n.Room)
                .WithMany(r => r.Notes)
                .HasForeignKey(n => n.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(n => n.RoomId);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\PersonalEventConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class PersonalEventConfiguration : IEntityTypeConfiguration<PersonalEvent>
    {
        public void Configure(EntityTypeBuilder<PersonalEvent> builder)
        {
            builder.ToTable("personal_events");

            builder.HasKey(pe => pe.Id);
            builder.Property(pe => pe.Id).ValueGeneratedOnAdd();

            builder.Property(pe => pe.StartTime)
                .IsRequired();

            builder.Property(pe => pe.EndTime)
                .IsRequired();

            builder.Property(pe => pe.Title)
                .IsRequired()
                .HasMaxLength(200);

            builder.Property(pe => pe.Description)
                .HasMaxLength(2000);

            builder.Property(pe => pe.Location)
                .HasMaxLength(500);

            builder.Property(pe => pe.IsFromTemplate)
                .IsRequired()
                .HasDefaultValue(false);

            // Связи
            builder.HasOne(pe => pe.User)
                .WithMany()
                .HasForeignKey(pe => pe.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(pe => pe.Template)
                .WithMany()
                .HasForeignKey(pe => pe.TemplateId)
                .OnDelete(DeleteBehavior.SetNull);

            // Индексы
            builder.HasIndex(pe => pe.UserId);
            builder.HasIndex(pe => pe.StartTime);
            builder.HasIndex(pe => pe.EndTime);
            builder.HasIndex(pe => new { pe.UserId, pe.StartTime });
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\PersonalEventExceptionConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class PersonalEventExceptionConfiguration : IEntityTypeConfiguration<PersonalEventException>
    {
        public void Configure(EntityTypeBuilder<PersonalEventException> builder)
        {
            builder.ToTable("personal_event_exceptions");

            builder.HasKey(pee => pee.Id);
            builder.Property(pee => pee.Id).ValueGeneratedOnAdd();

            builder.Property(pee => pee.ExceptionDate)
                .IsRequired();

            builder.Property(pee => pee.Type)
                .IsRequired()
                .HasConversion<string>()
                .HasMaxLength(20);

            builder.Property(pee => pee.NewDateTime);

            builder.Property(pee => pee.NewDuration)
                .HasColumnType("interval");

            builder.Property(pee => pee.Reason)
                .IsRequired()
                .HasMaxLength(500);

            // Связи
            builder.HasOne(pee => pee.Template)
                .WithMany(pet => pet.Exceptions)
                .HasForeignKey(pee => pee.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(pee => pee.CreatedEvent)
                .WithMany()
                .HasForeignKey(pee => pee.CreatedEventId)
                .OnDelete(DeleteBehavior.SetNull);

            // Индексы
            builder.HasIndex(pee => pee.TemplateId);
            builder.HasIndex(pee => pee.ExceptionDate);
            builder.HasIndex(pee => pee.Type);
            builder.HasIndex(pee => new { pee.TemplateId, pee.ExceptionDate }).IsUnique();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\PersonalEventTemplateConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Converters;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class PersonalEventTemplateConfiguration : IEntityTypeConfiguration<PersonalEventTemplate>
    {
        public void Configure(EntityTypeBuilder<PersonalEventTemplate> builder)
        {
            builder.ToTable("personal_event_templates");

            builder.HasKey(pet => pet.Id);
            builder.Property(pet => pet.Id).ValueGeneratedOnAdd();

            builder.Property(pet => pet.Title)
                .IsRequired()
                .HasMaxLength(200);

            builder.Property(pet => pet.Description)
                .HasMaxLength(2000);

            builder.Property(pet => pet.Location)
                .HasMaxLength(500);

            builder.Property(pet => pet.Duration)
                .IsRequired()
                .HasColumnType("interval");

            builder.Property(pet => pet.ValidFrom)
                .IsRequired()
                .HasConversion<DateOnlyConverter, DateOnlyComparer>();

            builder.Property(pet => pet.ValidUntil)
                .HasConversion<DateOnlyConverter, DateOnlyComparer>();

            // Связи
            builder.HasOne(pet => pet.User)
                .WithMany(u => u.PersonalEventTemplates)
                .HasForeignKey(pet => pet.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(pet => pet.RecurrencePattern)
                .WithOne(rp => rp.Template)
                .HasForeignKey<RecurrencePattern>(rp => rp.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(pet => pet.Exceptions)
                .WithOne(pee => pee.Template)
                .HasForeignKey(pee => pee.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(pet => pet.UserId);
            builder.HasIndex(pet => pet.ValidFrom);
            builder.HasIndex(pet => pet.ValidUntil);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\RecurrencePatternConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.ChangeTracking;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using System.Text.Json;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class RecurrencePatternConfiguration : IEntityTypeConfiguration<RecurrencePattern>
    {
        public void Configure(EntityTypeBuilder<RecurrencePattern> builder)
        {
            builder.ToTable("recurrence_patterns");

            builder.HasKey(rp => rp.Id);
            builder.Property(rp => rp.Id).ValueGeneratedOnAdd();

            builder.Property(rp => rp.Type)
                .IsRequired()
                .HasConversion<string>()
                .HasMaxLength(20);

            builder.Property(rp => rp.Interval)
                .IsRequired()
                .HasDefaultValue(1);

            // Хранение DaysOfWeek как JSON массива с ValueComparer
            builder.Property(rp => rp.DaysOfWeek)
                .HasConversion(
                    new ValueConverter<List<DayOfWeek>, string>(
                        v => JsonSerializer.Serialize(v, (JsonSerializerOptions?)null),
                        v => JsonSerializer.Deserialize<List<DayOfWeek>>(v, (JsonSerializerOptions?)null) ?? new List<DayOfWeek>()
                    ),
                    new ValueComparer<List<DayOfWeek>>(
                        (c1, c2) => c1.SequenceEqual(c2), // Сравнение элементов
                        c => c.Aggregate(0, (a, v) => HashCode.Combine(a, v.GetHashCode())), // Хеш-код
                        c => c.ToList() // Создание копии
                    )
                )
                .HasColumnType("jsonb");

            builder.Property(rp => rp.DayOfMonth);

            builder.Property(rp => rp.MonthlyType)
                .HasConversion<string>()
                .HasMaxLength(20);

            builder.Property(rp => rp.EndDate);

            builder.Property(rp => rp.OccurrenceCount);

            // Связи
            builder.HasOne(rp => rp.Template)
                .WithOne(pet => pet.RecurrencePattern)
                .HasForeignKey<RecurrencePattern>(rp => rp.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(rp => rp.TemplateId).IsUnique();
            builder.HasIndex(rp => rp.Type);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\RoomConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class RoomConfiguration : IEntityTypeConfiguration<Room>
    {
        public void Configure(EntityTypeBuilder<Room> builder)
        {
            builder.ToTable("rooms");

            builder.HasKey(r => r.Id);
            builder.Property(r => r.Id).ValueGeneratedOnAdd();

            builder.HasOne(r => r.Owner)
                .WithMany(u => u.Rooms)
                .HasForeignKey(r => r.OwnerId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(r => r.DefaultSettings)
                .WithOne(drs => drs.Room)
                .HasForeignKey<DefaultRoomSettings>(drs => drs.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(r => r.ScheduleTemplate)
                .WithOne(rst => rst.Room)
                .HasForeignKey<RoomScheduleTemplate>(rst => rst.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(r => r.Lessons)
                .WithOne(l => l.Room)
                .HasForeignKey(l => l.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(r => r.Homeworks)
                .WithOne(h => h.Room)
                .HasForeignKey(h => h.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(r => r.Notes)
                .WithOne(n => n.Room)
                .HasForeignKey(n => n.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(r => r.StudentId);
            builder.HasIndex(r => r.OwnerId);
            builder.HasIndex(r => r.CreatedAt);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\RoomScheduleTemplateConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Converters;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class RoomScheduleTemplateConfiguration : IEntityTypeConfiguration<RoomScheduleTemplate>
    {
        public void Configure(EntityTypeBuilder<RoomScheduleTemplate> builder)
        {
            builder.ToTable("room_schedule_templates");

            builder.HasKey(rst => rst.Id);
            builder.Property(rst => rst.Id).ValueGeneratedOnAdd();

            builder.Property(rst => rst.Name)
                .HasMaxLength(200);

            builder.Property(rst => rst.ValidFrom)
                .IsRequired()
                .HasConversion<DateOnlyConverter, DateOnlyComparer>();

            builder.Property(rst => rst.ValidUntil)
                .HasConversion<DateOnlyConverter, DateOnlyComparer>();

            // Связи
            builder.HasOne(rst => rst.Room)
                .WithOne(r => r.ScheduleTemplate)
                .HasForeignKey<RoomScheduleTemplate>(rst => rst.RoomId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(rst => rst.Rules)
                .WithOne(str => str.Template)
                .HasForeignKey(str => str.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(rst => rst.Exceptions)
                .WithOne(se => se.Template)
                .HasForeignKey(se => se.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(rst => rst.RoomId).IsUnique();
            builder.HasIndex(rst => rst.ValidFrom);
            builder.HasIndex(rst => rst.ValidUntil);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\ScheduleExceptionConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Converters;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class ScheduleExceptionConfiguration : IEntityTypeConfiguration<ScheduleException>
    {
        public void Configure(EntityTypeBuilder<ScheduleException> builder)
        {
            builder.ToTable("schedule_exceptions");

            builder.HasKey(se => se.Id);
            builder.Property(se => se.Id).ValueGeneratedOnAdd();

            builder.Property(se => se.ExceptionDate)
                .IsRequired()
                .HasConversion<DateOnlyConverter, DateOnlyComparer>();

            builder.Property(se => se.Type)
                .IsRequired()
                .HasConversion<string>()
                .HasMaxLength(20);

            builder.Property(se => se.NewDateTime);

            builder.Property(se => se.NewDuration)
                .HasColumnType("interval");

            builder.Property(se => se.NewPrice)
                .HasColumnType("decimal(10,2)");

            builder.Property(se => se.Reason)
                .IsRequired()
                .HasMaxLength(500);

            // Связи
            builder.HasOne(se => se.Template)
                .WithMany(rst => rst.Exceptions)
                .HasForeignKey(se => se.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasOne(se => se.CreatedLesson)
                .WithMany()
                .HasForeignKey(se => se.CreatedLessonId)
                .OnDelete(DeleteBehavior.SetNull);

            // Индексы
            builder.HasIndex(se => se.TemplateId);
            builder.HasIndex(se => se.ExceptionDate);
            builder.HasIndex(se => se.Type);
            builder.HasIndex(se => new { se.TemplateId, se.ExceptionDate }).IsUnique();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\ScheduleTemplateRuleConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Comparers;
using Lemmo.WebApi.Infrastructure.Data.Configurations.Converters;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class ScheduleTemplateRuleConfiguration : IEntityTypeConfiguration<ScheduleTemplateRule>
    {
        public void Configure(EntityTypeBuilder<ScheduleTemplateRule> builder)
        {
            builder.ToTable("schedule_template_rules");

            builder.HasKey(str => str.Id);
            builder.Property(str => str.Id).ValueGeneratedOnAdd();

            builder.Property(str => str.DayOfWeek)
                .IsRequired()
                .HasConversion<int>();

            builder.Property(str => str.StartTime)
                .IsRequired()
                .HasConversion<TimeOnlyConverter, TimeOnlyComparer>();

            builder.Property(str => str.Duration)
                .IsRequired()
                .HasColumnType("interval");

            builder.Property(str => str.Price)
                .IsRequired()
                .HasColumnType("decimal(10,2)");

            builder.Property(str => str.IsActive)
                .IsRequired()
                .HasDefaultValue(true);

            // Связи
            builder.HasOne(str => str.Template)
                .WithMany(rst => rst.Rules)
                .HasForeignKey(str => str.TemplateId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(str => str.TemplateId);
            builder.HasIndex(str => str.DayOfWeek);
            builder.HasIndex(str => str.IsActive);
            builder.HasIndex(str => new { str.TemplateId, str.DayOfWeek, str.StartTime }).IsUnique();
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\StudentConfiguration.cs =====

using Lemmo.WebApi.Entitys.Students;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class StudentConfiguration : IEntityTypeConfiguration<Student>
    {
        public void Configure(EntityTypeBuilder<Student> builder)
        {
            builder.ToTable("students");

            builder.HasKey(s => s.Id);
            builder.Property(s => s.Id).ValueGeneratedOnAdd();

            builder.Property(s => s.Name)
                .IsRequired()
                .HasMaxLength(200);

            builder.Property(s => s.Notes)
                .HasMaxLength(2000);

            builder.Property(s => s.UserId)
                .IsRequired();

            // Связи
            builder.HasOne(s => s.User)
                .WithMany()
                .HasForeignKey(s => s.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(s => s.Contacts)
                .WithOne(sc => sc.Student)
                .HasForeignKey(sc => sc.StudentId)
                .OnDelete(DeleteBehavior.Cascade);



            // Индексы
            builder.HasIndex(s => s.Name);
            builder.HasIndex(s => s.UserId);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\StudentContactConfiguration.cs =====

using Lemmo.WebApi.Entitys.Students;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class StudentContactConfiguration : IEntityTypeConfiguration<StudentContact>
    {
        public void Configure(EntityTypeBuilder<StudentContact> builder)
        {
            builder.ToTable("student_contacts");

            builder.HasKey(sc => sc.Id);
            builder.Property(sc => sc.Id).ValueGeneratedOnAdd();

            builder.Property(sc => sc.Value)
                .IsRequired()
                .HasMaxLength(200);

            builder.Property(sc => sc.Type)
                .IsRequired()
                .HasMaxLength(50)
                .HasConversion<string>();

            // Связи
            builder.HasOne(sc => sc.Student)
                .WithMany(s => s.Contacts)
                .HasForeignKey(sc => sc.StudentId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(sc => sc.StudentId);
            builder.HasIndex(sc => sc.Type);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\Configurations\UserConfiguration.cs =====

using Lemmo.WebApi.Entitys;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;

namespace Lemmo.WebApi.Infrastructure.Data.Configurations
{
    public class UserConfiguration : IEntityTypeConfiguration<User>
    {
        public void Configure(EntityTypeBuilder<User> builder)
        {
            builder.ToTable("users");

            builder.HasKey(u => u.Id);
            builder.Property(u => u.Id).ValueGeneratedOnAdd();

            builder.Property(u => u.PhoneNumber)
                .IsRequired()
                .HasMaxLength(20);

            builder.Property(u => u.TelegramId)
                .IsRequired()
                .HasMaxLength(50);

            builder.Property(u => u.PasswordHash)
                .IsRequired();

            // Связи
            builder.HasOne(u => u.DefaultLessonSettings)
                .WithOne(us => us.User)
                .HasForeignKey<DefaultUserLessonSettings>(us => us.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(u => u.Rooms)
                .WithOne(r => r.Owner)
                .HasForeignKey(r => r.OwnerId)
                .OnDelete(DeleteBehavior.Cascade);

            builder.HasMany(u => u.PersonalEventTemplates)
                .WithOne(pet => pet.User)
                .HasForeignKey(pet => pet.UserId)
                .OnDelete(DeleteBehavior.Cascade);

            // Индексы
            builder.HasIndex(u => u.PhoneNumber).IsUnique();
            builder.HasIndex(u => u.TelegramId).IsUnique();
            builder.HasIndex(u => u.CreatedAt);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\ApplicationDbContext.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Entitys.Common;
using Lemmo.WebApi.Entitys.Students;
using Lemmo.WebApi.Entitys.TelegramSessions;
using Lemmo.WebApi.Infrastructure.Data.Configurations;
using Microsoft.EntityFrameworkCore;

namespace Lemmo.WebApi.Infrastructure.Data
{
    public class ApplicationDbContext(DbContextOptions<ApplicationDbContext> options) : DbContext(options)
    {
        public DbSet<User> Users { get; set; }
        public DbSet<Room> Rooms { get; set; }
        public DbSet<Student> Students { get; set; }
        public DbSet<StudentContact> StudentContacts { get; set; }
        public DbSet<Homework> Homeworks { get; set; }
        public DbSet<Note> Notes { get; set; }
        public DbSet<Lesson> Lessons { get; set; }
        public DbSet<DefaultRoomSettings> DefaultRoomSettings { get; set; }
        public DbSet<DefaultUserLessonSettings> DefaultUserLessonSettings { get; set; }
        public DbSet<RoomScheduleTemplate> RoomScheduleTemplates { get; set; }
        public DbSet<ScheduleTemplateRule> ScheduleTemplateRules { get; set; }
        public DbSet<ScheduleException> ScheduleExceptions { get; set; }
        public DbSet<PersonalEvent> PersonalEvents { get; set; }
        public DbSet<PersonalEventTemplate> PersonalEventTemplates { get; set; }
        public DbSet<RecurrencePattern> RecurrencePatterns { get; set; }
        public DbSet<PersonalEventException> PersonalEventExceptions { get; set; }
        public DbSet<RefreshToken> RefreshTokens { get; set; }

        public DbSet<TelegramUserSession> TelegramUserSessions { get; set; }
        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            
            base.OnModelCreating(modelBuilder);

            // Устанавливаем схему
            modelBuilder.HasDefaultSchema("lemmo");

            // Игнорируем базовый класс EntityBase
            modelBuilder.Ignore<EntityBase>();

            modelBuilder.Entity<TelegramUserSession>()
                .HasIndex(s => s.TelegramUserId)
                .IsUnique();

            // Конфигурации
            modelBuilder.ApplyConfiguration(new UserConfiguration());
            modelBuilder.ApplyConfiguration(new RoomConfiguration());
            modelBuilder.ApplyConfiguration(new StudentConfiguration());
            modelBuilder.ApplyConfiguration(new StudentContactConfiguration());
            modelBuilder.ApplyConfiguration(new HomeworkConfiguration());
            modelBuilder.ApplyConfiguration(new NoteConfiguration());
            modelBuilder.ApplyConfiguration(new LessonConfiguration());
            modelBuilder.ApplyConfiguration(new DefaultRoomSettingsConfiguration());
            modelBuilder.ApplyConfiguration(new DefaultUserLessonSettingsConfiguration());
            modelBuilder.ApplyConfiguration(new RoomScheduleTemplateConfiguration());
            modelBuilder.ApplyConfiguration(new ScheduleTemplateRuleConfiguration());
            modelBuilder.ApplyConfiguration(new ScheduleExceptionConfiguration());
            modelBuilder.ApplyConfiguration(new PersonalEventConfiguration());
            modelBuilder.ApplyConfiguration(new PersonalEventTemplateConfiguration());
            modelBuilder.ApplyConfiguration(new RecurrencePatternConfiguration());
            modelBuilder.ApplyConfiguration(new PersonalEventExceptionConfiguration());
        }

        public override int SaveChanges()
        {
            UpdateTimestamps();
            return base.SaveChanges();
        }

        public override Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
        {
            UpdateTimestamps();
            return base.SaveChangesAsync(cancellationToken);
        }

        private void UpdateTimestamps()
        {
            var entries = ChangeTracker.Entries()
                .Where(e => e.Entity is EntityBase &&
                           (e.State == EntityState.Added || e.State == EntityState.Modified));

            foreach (var entry in entries)
            {
                var entity = (EntityBase)entry.Entity;

                if (entry.State == EntityState.Added)
                {
                    entity.CreatedAt = DateTimeOffset.UtcNow;
                }
                entity.UpdatedAt = DateTimeOffset.UtcNow;
            }
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\DataBaseExtentions.cs =====

using Microsoft.EntityFrameworkCore;

namespace Lemmo.WebApi.Infrastructure.Data
{
    public static class DataBaseExtentions
    {
        public static IServiceCollection AddAppDB(this IServiceCollection services, IConfiguration configuration)
        {
            services.AddDbContext<ApplicationDbContext>(options =>
            {
                options.UseNpgsql(
                    configuration.GetConnectionString("DefaultConnection"),
                    npgsqlOptions =>
                    {
                        npgsqlOptions.MigrationsAssembly(typeof(ApplicationDbContext).Assembly.FullName);
                    });
                options.EnableSensitiveDataLogging();
                options.EnableDetailedErrors();
                options.LogTo(Console.WriteLine, LogLevel.Information);
            });

            services.AddScoped<EfUnitOfWork>();

            return services;
        }

        public static IHost ApplyMigrations(this IHost host)
        {
            using var scope = host.Services.CreateScope();
            var db = scope.ServiceProvider.GetRequiredService<ApplicationDbContext>();
            try
            {
                db.Database.Migrate();
            }
            catch (Exception ex)
            {
                Console.WriteLine("Migration error: " + ex.Message);
            }
            return host;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Infrastructure\Data\EfUnitOfWork.cs =====

using Microsoft.EntityFrameworkCore.Storage;

namespace Lemmo.WebApi.Infrastructure.Data
{
    public class EfUnitOfWork(ApplicationDbContext db)
    {
        private IDbContextTransaction? _tx;

        public async Task BeginAsync(CancellationToken ct)
        {
            _tx = await db.Database.BeginTransactionAsync(ct);
        }

        public async Task CommitAsync(CancellationToken ct)
        {
            await db.SaveChangesAsync(ct);
            if (_tx != null)
                await _tx.CommitAsync(ct);
        }

        public async Task RollbackAsync(CancellationToken ct)
        {
            if (_tx != null)
                await _tx.RollbackAsync(ct);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224114143_InitDb.cs =====

using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class InitDb : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.EnsureSchema(
                name: "lemmo");

            migrationBuilder.CreateTable(
                name: "users",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Username = table.Column<string>(type: "character varying(100)", maxLength: 100, nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_users", x => x.Id);
                });

            migrationBuilder.CreateTable(
                name: "default_user_lesson_settings",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    DefaultPricePerHour = table.Column<double>(type: "numeric(10,2)", nullable: false),
                    DefaultDuration = table.Column<TimeSpan>(type: "interval", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_default_user_lesson_settings", x => x.Id);
                    table.ForeignKey(
                        name: "FK_default_user_lesson_settings_users_UserId",
                        column: x => x.UserId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "personal_event_templates",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    Title = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
                    Description = table.Column<string>(type: "character varying(2000)", maxLength: 2000, nullable: true),
                    Location = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: true),
                    Duration = table.Column<TimeSpan>(type: "interval", nullable: false),
                    ValidFrom = table.Column<DateTime>(type: "timestamp with time zone", nullable: false),
                    ValidUntil = table.Column<DateTime>(type: "timestamp with time zone", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_personal_event_templates", x => x.Id);
                    table.ForeignKey(
                        name: "FK_personal_event_templates_users_UserId",
                        column: x => x.UserId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "students",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
                    Notes = table.Column<string>(type: "character varying(2000)", maxLength: 2000, nullable: true),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_students", x => x.Id);
                    table.ForeignKey(
                        name: "FK_students_users_UserId",
                        column: x => x.UserId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "personal_events",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    StartTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    EndTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    Title = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
                    Description = table.Column<string>(type: "character varying(2000)", maxLength: 2000, nullable: true),
                    Location = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: true),
                    IsFromTemplate = table.Column<bool>(type: "boolean", nullable: false, defaultValue: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_personal_events", x => x.Id);
                    table.ForeignKey(
                        name: "FK_personal_events_personal_event_templates_TemplateId",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "personal_event_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.SetNull);
                    table.ForeignKey(
                        name: "FK_personal_events_users_UserId",
                        column: x => x.UserId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "recurrence_patterns",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: false),
                    Type = table.Column<string>(type: "character varying(20)", maxLength: 20, nullable: false),
                    Interval = table.Column<int>(type: "integer", nullable: false, defaultValue: 1),
                    DaysOfWeek = table.Column<string>(type: "jsonb", nullable: false),
                    DayOfMonth = table.Column<int>(type: "integer", nullable: true),
                    MonthlyType = table.Column<string>(type: "character varying(20)", maxLength: 20, nullable: true),
                    EndDate = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: true),
                    OccurrenceCount = table.Column<int>(type: "integer", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_recurrence_patterns", x => x.Id);
                    table.ForeignKey(
                        name: "FK_recurrence_patterns_personal_event_templates_TemplateId",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "personal_event_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "rooms",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    StudentId = table.Column<Guid>(type: "uuid", nullable: false),
                    OwnerId = table.Column<Guid>(type: "uuid", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_rooms", x => x.Id);
                    table.ForeignKey(
                        name: "FK_rooms_students_StudentId",
                        column: x => x.StudentId,
                        principalSchema: "lemmo",
                        principalTable: "students",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_rooms_users_OwnerId",
                        column: x => x.OwnerId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "student_contacts",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    StudentId = table.Column<Guid>(type: "uuid", nullable: false),
                    Value = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: false),
                    Type = table.Column<string>(type: "character varying(50)", maxLength: 50, nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_student_contacts", x => x.Id);
                    table.ForeignKey(
                        name: "FK_student_contacts_students_StudentId",
                        column: x => x.StudentId,
                        principalSchema: "lemmo",
                        principalTable: "students",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "personal_event_exceptions",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: false),
                    ExceptionDate = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    Type = table.Column<string>(type: "character varying(20)", maxLength: 20, nullable: false),
                    NewDateTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: true),
                    NewDuration = table.Column<TimeSpan>(type: "interval", nullable: true),
                    Reason = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
                    CreatedEventId = table.Column<Guid>(type: "uuid", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_personal_event_exceptions", x => x.Id);
                    table.ForeignKey(
                        name: "FK_personal_event_exceptions_personal_event_templates_Template~",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "personal_event_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_personal_event_exceptions_personal_events_CreatedEventId",
                        column: x => x.CreatedEventId,
                        principalSchema: "lemmo",
                        principalTable: "personal_events",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.SetNull);
                });

            migrationBuilder.CreateTable(
                name: "default_room_settings",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RoomId = table.Column<Guid>(type: "uuid", nullable: false),
                    DefaultPricePerHour = table.Column<double>(type: "numeric(10,2)", nullable: false),
                    DefaultDuration = table.Column<TimeSpan>(type: "interval", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_default_room_settings", x => x.Id);
                    table.ForeignKey(
                        name: "FK_default_room_settings_rooms_RoomId",
                        column: x => x.RoomId,
                        principalSchema: "lemmo",
                        principalTable: "rooms",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "homeworks",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RoomId = table.Column<Guid>(type: "uuid", nullable: false),
                    FileUrl = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
                    Deadline = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_homeworks", x => x.Id);
                    table.ForeignKey(
                        name: "FK_homeworks_rooms_RoomId",
                        column: x => x.RoomId,
                        principalSchema: "lemmo",
                        principalTable: "rooms",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "notes",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RoomId = table.Column<Guid>(type: "uuid", nullable: false),
                    FileUrl = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_notes", x => x.Id);
                    table.ForeignKey(
                        name: "FK_notes_rooms_RoomId",
                        column: x => x.RoomId,
                        principalSchema: "lemmo",
                        principalTable: "rooms",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "room_schedule_templates",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RoomId = table.Column<Guid>(type: "uuid", nullable: false),
                    Name = table.Column<string>(type: "character varying(200)", maxLength: 200, nullable: true),
                    ValidFrom = table.Column<DateTime>(type: "timestamp with time zone", nullable: false),
                    ValidUntil = table.Column<DateTime>(type: "timestamp with time zone", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_room_schedule_templates", x => x.Id);
                    table.ForeignKey(
                        name: "FK_room_schedule_templates_rooms_RoomId",
                        column: x => x.RoomId,
                        principalSchema: "lemmo",
                        principalTable: "rooms",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "schedule_template_rules",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: false),
                    DayOfWeek = table.Column<int>(type: "integer", nullable: false),
                    StartTime = table.Column<TimeSpan>(type: "interval", nullable: false),
                    Duration = table.Column<TimeSpan>(type: "interval", nullable: false),
                    Price = table.Column<double>(type: "numeric(10,2)", nullable: false),
                    IsActive = table.Column<bool>(type: "boolean", nullable: false, defaultValue: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_schedule_template_rules", x => x.Id);
                    table.ForeignKey(
                        name: "FK_schedule_template_rules_room_schedule_templates_TemplateId",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "room_schedule_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateTable(
                name: "lessons",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    RoomId = table.Column<Guid>(type: "uuid", nullable: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: true),
                    TemplateRuleId = table.Column<Guid>(type: "uuid", nullable: true),
                    StartTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    Duration = table.Column<TimeSpan>(type: "interval", nullable: false),
                    Price = table.Column<double>(type: "numeric(10,2)", nullable: false),
                    Status = table.Column<string>(type: "character varying(20)", maxLength: 20, nullable: false),
                    Notes = table.Column<string>(type: "character varying(2000)", maxLength: 2000, nullable: true),
                    IsModified = table.Column<bool>(type: "boolean", nullable: false),
                    OriginalPlannedTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: true),
                    ModificationReason = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_lessons", x => x.Id);
                    table.ForeignKey(
                        name: "FK_lessons_room_schedule_templates_TemplateId",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "room_schedule_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.SetNull);
                    table.ForeignKey(
                        name: "FK_lessons_rooms_RoomId",
                        column: x => x.RoomId,
                        principalSchema: "lemmo",
                        principalTable: "rooms",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                    table.ForeignKey(
                        name: "FK_lessons_schedule_template_rules_TemplateRuleId",
                        column: x => x.TemplateRuleId,
                        principalSchema: "lemmo",
                        principalTable: "schedule_template_rules",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.SetNull);
                });

            migrationBuilder.CreateTable(
                name: "schedule_exceptions",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    TemplateId = table.Column<Guid>(type: "uuid", nullable: false),
                    ExceptionDate = table.Column<DateTime>(type: "timestamp with time zone", nullable: false),
                    Type = table.Column<string>(type: "character varying(20)", maxLength: 20, nullable: false),
                    NewDateTime = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: true),
                    NewDuration = table.Column<TimeSpan>(type: "interval", nullable: true),
                    NewPrice = table.Column<double>(type: "numeric(10,2)", nullable: true),
                    Reason = table.Column<string>(type: "character varying(500)", maxLength: 500, nullable: false),
                    CreatedLessonId = table.Column<Guid>(type: "uuid", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_schedule_exceptions", x => x.Id);
                    table.ForeignKey(
                        name: "FK_schedule_exceptions_lessons_CreatedLessonId",
                        column: x => x.CreatedLessonId,
                        principalSchema: "lemmo",
                        principalTable: "lessons",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.SetNull);
                    table.ForeignKey(
                        name: "FK_schedule_exceptions_room_schedule_templates_TemplateId",
                        column: x => x.TemplateId,
                        principalSchema: "lemmo",
                        principalTable: "room_schedule_templates",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_default_room_settings_RoomId",
                schema: "lemmo",
                table: "default_room_settings",
                column: "RoomId",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_default_user_lesson_settings_UserId",
                schema: "lemmo",
                table: "default_user_lesson_settings",
                column: "UserId",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_homeworks_Deadline",
                schema: "lemmo",
                table: "homeworks",
                column: "Deadline");

            migrationBuilder.CreateIndex(
                name: "IX_homeworks_RoomId",
                schema: "lemmo",
                table: "homeworks",
                column: "RoomId");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_OriginalPlannedTime",
                schema: "lemmo",
                table: "lessons",
                column: "OriginalPlannedTime");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_RoomId",
                schema: "lemmo",
                table: "lessons",
                column: "RoomId");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_RoomId_StartTime",
                schema: "lemmo",
                table: "lessons",
                columns: new[] { "RoomId", "StartTime" });

            migrationBuilder.CreateIndex(
                name: "IX_lessons_StartTime",
                schema: "lemmo",
                table: "lessons",
                column: "StartTime");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_Status",
                schema: "lemmo",
                table: "lessons",
                column: "Status");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_TemplateId",
                schema: "lemmo",
                table: "lessons",
                column: "TemplateId");

            migrationBuilder.CreateIndex(
                name: "IX_lessons_TemplateRuleId",
                schema: "lemmo",
                table: "lessons",
                column: "TemplateRuleId");

            migrationBuilder.CreateIndex(
                name: "IX_notes_RoomId",
                schema: "lemmo",
                table: "notes",
                column: "RoomId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_exceptions_CreatedEventId",
                schema: "lemmo",
                table: "personal_event_exceptions",
                column: "CreatedEventId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_exceptions_ExceptionDate",
                schema: "lemmo",
                table: "personal_event_exceptions",
                column: "ExceptionDate");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_exceptions_TemplateId",
                schema: "lemmo",
                table: "personal_event_exceptions",
                column: "TemplateId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_exceptions_TemplateId_ExceptionDate",
                schema: "lemmo",
                table: "personal_event_exceptions",
                columns: new[] { "TemplateId", "ExceptionDate" },
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_exceptions_Type",
                schema: "lemmo",
                table: "personal_event_exceptions",
                column: "Type");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_templates_UserId",
                schema: "lemmo",
                table: "personal_event_templates",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_templates_ValidFrom",
                schema: "lemmo",
                table: "personal_event_templates",
                column: "ValidFrom");

            migrationBuilder.CreateIndex(
                name: "IX_personal_event_templates_ValidUntil",
                schema: "lemmo",
                table: "personal_event_templates",
                column: "ValidUntil");

            migrationBuilder.CreateIndex(
                name: "IX_personal_events_EndTime",
                schema: "lemmo",
                table: "personal_events",
                column: "EndTime");

            migrationBuilder.CreateIndex(
                name: "IX_personal_events_StartTime",
                schema: "lemmo",
                table: "personal_events",
                column: "StartTime");

            migrationBuilder.CreateIndex(
                name: "IX_personal_events_TemplateId",
                schema: "lemmo",
                table: "personal_events",
                column: "TemplateId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_events_UserId",
                schema: "lemmo",
                table: "personal_events",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_personal_events_UserId_StartTime",
                schema: "lemmo",
                table: "personal_events",
                columns: new[] { "UserId", "StartTime" });

            migrationBuilder.CreateIndex(
                name: "IX_recurrence_patterns_TemplateId",
                schema: "lemmo",
                table: "recurrence_patterns",
                column: "TemplateId",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_recurrence_patterns_Type",
                schema: "lemmo",
                table: "recurrence_patterns",
                column: "Type");

            migrationBuilder.CreateIndex(
                name: "IX_room_schedule_templates_RoomId",
                schema: "lemmo",
                table: "room_schedule_templates",
                column: "RoomId",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_room_schedule_templates_ValidFrom",
                schema: "lemmo",
                table: "room_schedule_templates",
                column: "ValidFrom");

            migrationBuilder.CreateIndex(
                name: "IX_room_schedule_templates_ValidUntil",
                schema: "lemmo",
                table: "room_schedule_templates",
                column: "ValidUntil");

            migrationBuilder.CreateIndex(
                name: "IX_rooms_CreatedAt",
                schema: "lemmo",
                table: "rooms",
                column: "CreatedAt");

            migrationBuilder.CreateIndex(
                name: "IX_rooms_OwnerId",
                schema: "lemmo",
                table: "rooms",
                column: "OwnerId");

            migrationBuilder.CreateIndex(
                name: "IX_rooms_StudentId",
                schema: "lemmo",
                table: "rooms",
                column: "StudentId");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_exceptions_CreatedLessonId",
                schema: "lemmo",
                table: "schedule_exceptions",
                column: "CreatedLessonId");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_exceptions_ExceptionDate",
                schema: "lemmo",
                table: "schedule_exceptions",
                column: "ExceptionDate");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_exceptions_TemplateId",
                schema: "lemmo",
                table: "schedule_exceptions",
                column: "TemplateId");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_exceptions_TemplateId_ExceptionDate",
                schema: "lemmo",
                table: "schedule_exceptions",
                columns: new[] { "TemplateId", "ExceptionDate" },
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_schedule_exceptions_Type",
                schema: "lemmo",
                table: "schedule_exceptions",
                column: "Type");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_template_rules_DayOfWeek",
                schema: "lemmo",
                table: "schedule_template_rules",
                column: "DayOfWeek");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_template_rules_IsActive",
                schema: "lemmo",
                table: "schedule_template_rules",
                column: "IsActive");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_template_rules_TemplateId",
                schema: "lemmo",
                table: "schedule_template_rules",
                column: "TemplateId");

            migrationBuilder.CreateIndex(
                name: "IX_schedule_template_rules_TemplateId_DayOfWeek_StartTime",
                schema: "lemmo",
                table: "schedule_template_rules",
                columns: new[] { "TemplateId", "DayOfWeek", "StartTime" },
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_student_contacts_StudentId",
                schema: "lemmo",
                table: "student_contacts",
                column: "StudentId");

            migrationBuilder.CreateIndex(
                name: "IX_student_contacts_Type",
                schema: "lemmo",
                table: "student_contacts",
                column: "Type");

            migrationBuilder.CreateIndex(
                name: "IX_students_Name",
                schema: "lemmo",
                table: "students",
                column: "Name");

            migrationBuilder.CreateIndex(
                name: "IX_students_UserId",
                schema: "lemmo",
                table: "students",
                column: "UserId");

            migrationBuilder.CreateIndex(
                name: "IX_users_CreatedAt",
                schema: "lemmo",
                table: "users",
                column: "CreatedAt");

            migrationBuilder.CreateIndex(
                name: "IX_users_Username",
                schema: "lemmo",
                table: "users",
                column: "Username",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "default_room_settings",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "default_user_lesson_settings",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "homeworks",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "notes",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "personal_event_exceptions",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "recurrence_patterns",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "schedule_exceptions",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "student_contacts",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "personal_events",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "lessons",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "personal_event_templates",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "schedule_template_rules",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "room_schedule_templates",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "rooms",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "students",
                schema: "lemmo");

            migrationBuilder.DropTable(
                name: "users",
                schema: "lemmo");
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224114143_InitDb.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251224114143_InitDb")]
    partial class InitDb
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Username")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("character varying(100)");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("Username")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224115127_FixRecurrencePatternComparer.cs =====

using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class FixRecurrencePatternComparer : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {

        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {

        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224115127_FixRecurrencePatternComparer.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251224115127_FixRecurrencePatternComparer")]
    partial class FixRecurrencePatternComparer
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Username")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("character varying(100)");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("Username")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224135907_AddAuth.cs =====

using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class AddAuth : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.AddColumn<string>(
                name: "FirstName",
                schema: "lemmo",
                table: "users",
                type: "text",
                nullable: false,
                defaultValue: "");

            migrationBuilder.AddColumn<string>(
                name: "LastName",
                schema: "lemmo",
                table: "users",
                type: "text",
                nullable: true);

            migrationBuilder.AddColumn<string>(
                name: "PasswordHash",
                schema: "lemmo",
                table: "users",
                type: "text",
                nullable: false,
                defaultValue: "");

            migrationBuilder.AddColumn<bool>(
                name: "TelegramConfirmed",
                schema: "lemmo",
                table: "users",
                type: "boolean",
                nullable: false,
                defaultValue: false);

            migrationBuilder.AddColumn<long>(
                name: "TelegramId",
                schema: "lemmo",
                table: "users",
                type: "bigint",
                nullable: false,
                defaultValue: 0L);

            migrationBuilder.CreateTable(
                name: "RefreshTokens",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    Token = table.Column<string>(type: "text", nullable: false),
                    ExpiresAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: false),
                    IsRevoked = table.Column<bool>(type: "boolean", nullable: false),
                    RevokedAt = table.Column<DateTime>(type: "timestamp with time zone", nullable: true),
                    UserId = table.Column<Guid>(type: "uuid", nullable: false),
                    Device = table.Column<string>(type: "text", nullable: true),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_RefreshTokens", x => x.Id);
                    table.ForeignKey(
                        name: "FK_RefreshTokens_users_UserId",
                        column: x => x.UserId,
                        principalSchema: "lemmo",
                        principalTable: "users",
                        principalColumn: "Id",
                        onDelete: ReferentialAction.Cascade);
                });

            migrationBuilder.CreateIndex(
                name: "IX_RefreshTokens_UserId",
                schema: "lemmo",
                table: "RefreshTokens",
                column: "UserId");
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "RefreshTokens",
                schema: "lemmo");

            migrationBuilder.DropColumn(
                name: "FirstName",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "LastName",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "PasswordHash",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "TelegramConfirmed",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "TelegramId",
                schema: "lemmo",
                table: "users");
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224135907_AddAuth.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251224135907_AddAuth")]
    partial class AddAuth
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Device")
                        .HasColumnType("text");

                    b.Property<DateTime>("ExpiresAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsRevoked")
                        .HasColumnType("boolean");

                    b.Property<DateTime?>("RevokedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Token")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("RefreshTokens", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FirstName")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("LastName")
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<bool>("TelegramConfirmed")
                        .HasColumnType("boolean");

                    b.Property<long>("TelegramId")
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Username")
                        .IsRequired()
                        .HasMaxLength(100)
                        .HasColumnType("character varying(100)");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("Username")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("RefreshTokens")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("RefreshTokens");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224142943_UpdateUser.cs =====

using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class UpdateUser : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropIndex(
                name: "IX_users_Username",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "TelegramConfirmed",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "Username",
                schema: "lemmo",
                table: "users");

            migrationBuilder.AlterColumn<string>(
                name: "FirstName",
                schema: "lemmo",
                table: "users",
                type: "text",
                nullable: true,
                oldClrType: typeof(string),
                oldType: "text");

            migrationBuilder.AddColumn<string>(
                name: "PhoneNumber",
                schema: "lemmo",
                table: "users",
                type: "character varying(20)",
                maxLength: 20,
                nullable: false,
                defaultValue: "");

            migrationBuilder.CreateIndex(
                name: "IX_users_PhoneNumber",
                schema: "lemmo",
                table: "users",
                column: "PhoneNumber",
                unique: true);

            migrationBuilder.CreateIndex(
                name: "IX_users_TelegramId",
                schema: "lemmo",
                table: "users",
                column: "TelegramId",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropIndex(
                name: "IX_users_PhoneNumber",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropIndex(
                name: "IX_users_TelegramId",
                schema: "lemmo",
                table: "users");

            migrationBuilder.DropColumn(
                name: "PhoneNumber",
                schema: "lemmo",
                table: "users");

            migrationBuilder.AlterColumn<string>(
                name: "FirstName",
                schema: "lemmo",
                table: "users",
                type: "text",
                nullable: false,
                defaultValue: "",
                oldClrType: typeof(string),
                oldType: "text",
                oldNullable: true);

            migrationBuilder.AddColumn<bool>(
                name: "TelegramConfirmed",
                schema: "lemmo",
                table: "users",
                type: "boolean",
                nullable: false,
                defaultValue: false);

            migrationBuilder.AddColumn<string>(
                name: "Username",
                schema: "lemmo",
                table: "users",
                type: "character varying(100)",
                maxLength: 100,
                nullable: false,
                defaultValue: "");

            migrationBuilder.CreateIndex(
                name: "IX_users_Username",
                schema: "lemmo",
                table: "users",
                column: "Username",
                unique: true);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224142943_UpdateUser.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251224142943_UpdateUser")]
    partial class UpdateUser
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Device")
                        .HasColumnType("text");

                    b.Property<DateTime>("ExpiresAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsRevoked")
                        .HasColumnType("boolean");

                    b.Property<DateTime?>("RevokedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Token")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("RefreshTokens", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FirstName")
                        .HasColumnType("text");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("LastName")
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<long>("TelegramId")
                        .HasMaxLength(50)
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("PhoneNumber")
                        .IsUnique();

                    b.HasIndex("TelegramId")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("RefreshTokens")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("RefreshTokens");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224153318_AddTelegramSessions.cs =====

using System;
using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class AddTelegramSessions : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.CreateTable(
                name: "TelegramUserSessions",
                schema: "lemmo",
                columns: table => new
                {
                    Id = table.Column<Guid>(type: "uuid", nullable: false),
                    TelegramUserId = table.Column<long>(type: "bigint", nullable: false),
                    PhoneNumber = table.Column<string>(type: "text", nullable: true),
                    State = table.Column<int>(type: "integer", nullable: false),
                    LastActivity = table.Column<DateTime>(type: "timestamp with time zone", nullable: false),
                    CreatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    UpdatedAt = table.Column<DateTimeOffset>(type: "timestamp with time zone", nullable: false),
                    IsDeleted = table.Column<bool>(type: "boolean", nullable: false)
                },
                constraints: table =>
                {
                    table.PrimaryKey("PK_TelegramUserSessions", x => x.Id);
                });

            migrationBuilder.CreateIndex(
                name: "IX_TelegramUserSessions_TelegramUserId",
                schema: "lemmo",
                table: "TelegramUserSessions",
                column: "TelegramUserId",
                unique: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.DropTable(
                name: "TelegramUserSessions",
                schema: "lemmo");
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251224153318_AddTelegramSessions.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251224153318_AddTelegramSessions")]
    partial class AddTelegramSessions
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Device")
                        .HasColumnType("text");

                    b.Property<DateTime>("ExpiresAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsRevoked")
                        .HasColumnType("boolean");

                    b.Property<DateTime?>("RevokedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Token")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("RefreshTokens", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.TelegramUserSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTime>("LastActivity")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("text");

                    b.Property<int>("State")
                        .HasColumnType("integer");

                    b.Property<long>("TelegramUserId")
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TelegramUserId")
                        .IsUnique();

                    b.ToTable("TelegramUserSessions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FirstName")
                        .HasColumnType("text");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("LastName")
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<long>("TelegramId")
                        .HasMaxLength(50)
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("PhoneNumber")
                        .IsUnique();

                    b.HasIndex("TelegramId")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("RefreshTokens")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("RefreshTokens");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251225185511_UpdateRefreshTokenModel.cs =====

using Microsoft.EntityFrameworkCore.Migrations;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    /// <inheritdoc />
    public partial class UpdateRefreshTokenModel : Migration
    {
        /// <inheritdoc />
        protected override void Up(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.RenameColumn(
                name: "Token",
                schema: "lemmo",
                table: "RefreshTokens",
                newName: "TokenHash");

            migrationBuilder.AlterColumn<string>(
                name: "Device",
                schema: "lemmo",
                table: "RefreshTokens",
                type: "text",
                nullable: false,
                defaultValue: "",
                oldClrType: typeof(string),
                oldType: "text",
                oldNullable: true);
        }

        /// <inheritdoc />
        protected override void Down(MigrationBuilder migrationBuilder)
        {
            migrationBuilder.RenameColumn(
                name: "TokenHash",
                schema: "lemmo",
                table: "RefreshTokens",
                newName: "Token");

            migrationBuilder.AlterColumn<string>(
                name: "Device",
                schema: "lemmo",
                table: "RefreshTokens",
                type: "text",
                nullable: true,
                oldClrType: typeof(string),
                oldType: "text");
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\20251225185511_UpdateRefreshTokenModel.Designer.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Migrations;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    [Migration("20251225185511_UpdateRefreshTokenModel")]
    partial class UpdateRefreshTokenModel
    {
        /// <inheritdoc />
        protected override void BuildTargetModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Device")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTime>("ExpiresAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsRevoked")
                        .HasColumnType("boolean");

                    b.Property<DateTime?>("RevokedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("TokenHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("RefreshTokens", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.TelegramSessions.TelegramUserSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTime>("LastActivity")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("text");

                    b.Property<int>("State")
                        .HasColumnType("integer");

                    b.Property<long>("TelegramUserId")
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TelegramUserId")
                        .IsUnique();

                    b.ToTable("TelegramUserSessions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FirstName")
                        .HasColumnType("text");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("LastName")
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<long>("TelegramId")
                        .HasMaxLength(50)
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("PhoneNumber")
                        .IsUnique();

                    b.HasIndex("TelegramId")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("RefreshTokens")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("RefreshTokens");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Migrations\ApplicationDbContextModelSnapshot.cs =====

// <auto-generated />
using System;
using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Infrastructure;
using Microsoft.EntityFrameworkCore.Storage.ValueConversion;
using Npgsql.EntityFrameworkCore.PostgreSQL.Metadata;

#nullable disable

namespace Lemmo.WebApi.Migrations
{
    [DbContext(typeof(ApplicationDbContext))]
    partial class ApplicationDbContextModelSnapshot : ModelSnapshot
    {
        protected override void BuildModel(ModelBuilder modelBuilder)
        {
#pragma warning disable 612, 618
            modelBuilder
                .HasDefaultSchema("lemmo")
                .HasAnnotation("ProductVersion", "8.0.22")
                .HasAnnotation("Relational:MaxIdentifierLength", 63);

            NpgsqlModelBuilderExtensions.UseIdentityByDefaultColumns(modelBuilder);

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.ToTable("default_room_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("DefaultDuration")
                        .HasColumnType("interval");

                    b.Property<double>("DefaultPricePerHour")
                        .HasColumnType("decimal(10,2)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId")
                        .IsUnique();

                    b.ToTable("default_user_lesson_settings", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTimeOffset>("Deadline")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("Deadline");

                    b.HasIndex("RoomId");

                    b.ToTable("homeworks", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsModified")
                        .HasColumnType("boolean");

                    b.Property<string>("ModificationReason")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset?>("OriginalPlannedTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Status")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<Guid?>("TemplateRuleId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("OriginalPlannedTime");

                    b.HasIndex("RoomId");

                    b.HasIndex("StartTime");

                    b.HasIndex("Status");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateRuleId");

                    b.HasIndex("RoomId", "StartTime");

                    b.ToTable("lessons", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FileUrl")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId");

                    b.ToTable("notes", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("EndTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsFromTemplate")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(false);

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<DateTimeOffset>("StartTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("EndTime");

                    b.HasIndex("StartTime");

                    b.HasIndex("TemplateId");

                    b.HasIndex("UserId");

                    b.HasIndex("UserId", "StartTime");

                    b.ToTable("personal_events", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedEventId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedEventId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("personal_event_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Description")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Location")
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<string>("Title")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("personal_event_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int?>("DayOfMonth")
                        .HasColumnType("integer");

                    b.Property<string>("DaysOfWeek")
                        .IsRequired()
                        .HasColumnType("jsonb");

                    b.Property<DateTimeOffset?>("EndDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("Interval")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("integer")
                        .HasDefaultValue(1);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("MonthlyType")
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<int?>("OccurrenceCount")
                        .HasColumnType("integer");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TemplateId")
                        .IsUnique();

                    b.HasIndex("Type");

                    b.ToTable("recurrence_patterns", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Device")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTime>("ExpiresAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<bool>("IsRevoked")
                        .HasColumnType("boolean");

                    b.Property<DateTime?>("RevokedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("TokenHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("UserId");

                    b.ToTable("RefreshTokens", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("OwnerId")
                        .HasColumnType("uuid");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("OwnerId");

                    b.HasIndex("StudentId");

                    b.ToTable("rooms", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<Guid>("RoomId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime>("ValidFrom")
                        .HasColumnType("timestamp with time zone");

                    b.Property<DateTime?>("ValidUntil")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("RoomId")
                        .IsUnique();

                    b.HasIndex("ValidFrom");

                    b.HasIndex("ValidUntil");

                    b.ToTable("room_schedule_templates", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid?>("CreatedLessonId")
                        .HasColumnType("uuid");

                    b.Property<DateTime>("ExceptionDate")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTimeOffset?>("NewDateTime")
                        .HasColumnType("timestamp with time zone");

                    b.Property<TimeSpan?>("NewDuration")
                        .HasColumnType("interval");

                    b.Property<double?>("NewPrice")
                        .HasColumnType("decimal(10,2)");

                    b.Property<string>("Reason")
                        .IsRequired()
                        .HasMaxLength(500)
                        .HasColumnType("character varying(500)");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedLessonId");

                    b.HasIndex("ExceptionDate");

                    b.HasIndex("TemplateId");

                    b.HasIndex("Type");

                    b.HasIndex("TemplateId", "ExceptionDate")
                        .IsUnique();

                    b.ToTable("schedule_exceptions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<int>("DayOfWeek")
                        .HasColumnType("integer");

                    b.Property<TimeSpan>("Duration")
                        .HasColumnType("interval");

                    b.Property<bool>("IsActive")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("boolean")
                        .HasDefaultValue(true);

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<double>("Price")
                        .HasColumnType("decimal(10,2)");

                    b.Property<TimeSpan>("StartTime")
                        .HasColumnType("interval");

                    b.Property<Guid>("TemplateId")
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("DayOfWeek");

                    b.HasIndex("IsActive");

                    b.HasIndex("TemplateId");

                    b.HasIndex("TemplateId", "DayOfWeek", "StartTime")
                        .IsUnique();

                    b.ToTable("schedule_template_rules", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("Name")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.Property<string>("Notes")
                        .HasMaxLength(2000)
                        .HasColumnType("character varying(2000)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<Guid>("UserId")
                        .HasColumnType("uuid");

                    b.HasKey("Id");

                    b.HasIndex("Name");

                    b.HasIndex("UserId");

                    b.ToTable("students", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<Guid>("StudentId")
                        .HasColumnType("uuid");

                    b.Property<string>("Type")
                        .IsRequired()
                        .HasMaxLength(50)
                        .HasColumnType("character varying(50)");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("Value")
                        .IsRequired()
                        .HasMaxLength(200)
                        .HasColumnType("character varying(200)");

                    b.HasKey("Id");

                    b.HasIndex("StudentId");

                    b.HasIndex("Type");

                    b.ToTable("student_contacts", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.TelegramSessions.TelegramUserSession", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<DateTime>("LastActivity")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("PhoneNumber")
                        .HasColumnType("text");

                    b.Property<int>("State")
                        .HasColumnType("integer");

                    b.Property<long>("TelegramUserId")
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("TelegramUserId")
                        .IsUnique();

                    b.ToTable("TelegramUserSessions", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Property<Guid>("Id")
                        .ValueGeneratedOnAdd()
                        .HasColumnType("uuid");

                    b.Property<DateTimeOffset>("CreatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.Property<string>("FirstName")
                        .HasColumnType("text");

                    b.Property<bool>("IsDeleted")
                        .HasColumnType("boolean");

                    b.Property<string>("LastName")
                        .HasColumnType("text");

                    b.Property<string>("PasswordHash")
                        .IsRequired()
                        .HasColumnType("text");

                    b.Property<string>("PhoneNumber")
                        .IsRequired()
                        .HasMaxLength(20)
                        .HasColumnType("character varying(20)");

                    b.Property<long>("TelegramId")
                        .HasMaxLength(50)
                        .HasColumnType("bigint");

                    b.Property<DateTimeOffset>("UpdatedAt")
                        .HasColumnType("timestamp with time zone");

                    b.HasKey("Id");

                    b.HasIndex("CreatedAt");

                    b.HasIndex("PhoneNumber")
                        .IsUnique();

                    b.HasIndex("TelegramId")
                        .IsUnique();

                    b.ToTable("users", "lemmo");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultRoomSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("DefaultSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultRoomSettings", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithOne("DefaultLessonSettings")
                        .HasForeignKey("Lemmo.WebApi.Entitys.DefaultUserLessonSettings", "UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Homework", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Homeworks")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Lesson", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Lessons")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.ScheduleTemplateRule", "TemplateRule")
                        .WithMany()
                        .HasForeignKey("TemplateRuleId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.Navigation("Room");

                    b.Navigation("Template");

                    b.Navigation("TemplateRule");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Note", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithMany("Notes")
                        .HasForeignKey("RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEvent", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany()
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEvent", "CreatedEvent")
                        .WithMany()
                        .HasForeignKey("CreatedEventId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedEvent");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("PersonalEventTemplates")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RecurrencePattern", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.PersonalEventTemplate", "Template")
                        .WithOne("RecurrencePattern")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RecurrencePattern", "TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RefreshToken", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany("RefreshTokens")
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "Owner")
                        .WithMany("Rooms")
                        .HasForeignKey("OwnerId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany()
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Owner");

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Room", "Room")
                        .WithOne("ScheduleTemplate")
                        .HasForeignKey("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "RoomId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Room");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleException", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Lesson", "CreatedLesson")
                        .WithMany()
                        .HasForeignKey("CreatedLessonId")
                        .OnDelete(DeleteBehavior.SetNull);

                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Exceptions")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("CreatedLesson");

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.ScheduleTemplateRule", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.RoomScheduleTemplate", "Template")
                        .WithMany("Rules")
                        .HasForeignKey("TemplateId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Template");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.User", "User")
                        .WithMany()
                        .HasForeignKey("UserId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("User");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.StudentContact", b =>
                {
                    b.HasOne("Lemmo.WebApi.Entitys.Students.Student", "Student")
                        .WithMany("Contacts")
                        .HasForeignKey("StudentId")
                        .OnDelete(DeleteBehavior.Cascade)
                        .IsRequired();

                    b.Navigation("Student");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.PersonalEventTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("RecurrencePattern")
                        .IsRequired();
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Room", b =>
                {
                    b.Navigation("DefaultSettings")
                        .IsRequired();

                    b.Navigation("Homeworks");

                    b.Navigation("Lessons");

                    b.Navigation("Notes");

                    b.Navigation("ScheduleTemplate");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.RoomScheduleTemplate", b =>
                {
                    b.Navigation("Exceptions");

                    b.Navigation("Rules");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.Students.Student", b =>
                {
                    b.Navigation("Contacts");
                });

            modelBuilder.Entity("Lemmo.WebApi.Entitys.User", b =>
                {
                    b.Navigation("DefaultLessonSettings")
                        .IsRequired();

                    b.Navigation("PersonalEventTemplates");

                    b.Navigation("RefreshTokens");

                    b.Navigation("Rooms");
                });
#pragma warning restore 612, 618
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Implementations\AuthManager.cs =====

using Lemmo.WebApi.Entitys;
using Lemmo.WebApi.Entitys.TelegramSessions;
using Lemmo.WebApi.Entitys.TelegramSessions.Enums;
using Lemmo.WebApi.Infrastructure.Data;
using Lemmo.WebApi.Persistance.Auth.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace Lemmo.WebApi.Persistance.Auth.Implementations
{
    public class AuthManager(ApplicationDbContext dbContext, EfUnitOfWork efUnitOfWork, ITokenService tokenService, IHasher hasher, IConfiguration configuration) : IAuthManager
    {
        public async Task CreateAccount(string phoneNumber, string password, long telegramId, CancellationToken cancellationToken = default)
        {
            try
            {
                await efUnitOfWork.BeginAsync(cancellationToken);

                var user = new User
                {
                    TelegramId = telegramId,
                    PhoneNumber = phoneNumber,
                    PasswordHash = hasher.HashPassword(password),
                    CreatedAt = DateTime.UtcNow
                };

                dbContext.Users.Add(user);

                var session = await dbContext.TelegramUserSessions
                    .FirstOrDefaultAsync(s => s.TelegramUserId == telegramId, cancellationToken: cancellationToken)
                        ?? throw new InvalidOperationException("Telegram user session not found.");

                dbContext.TelegramUserSessions.Remove(session);

                await efUnitOfWork.CommitAsync(cancellationToken);
            }
            catch (Exception ex)
            {
                await efUnitOfWork.RollbackAsync(cancellationToken);
            }
        }

        public async Task DeleteTelegramSessionAsync(long telegramId, CancellationToken cancellationToken = default)
        {
            var session = await dbContext.TelegramUserSessions
                    .FirstOrDefaultAsync(s => s.TelegramUserId == telegramId, cancellationToken: cancellationToken)
                        ?? throw new InvalidOperationException("Telegram user session not found.");
            dbContext.TelegramUserSessions.Remove(session);
            await dbContext.SaveChangesAsync(cancellationToken);
        }

        public async Task CreateOrUpdateTelegramSessionAsync(long telegramId, string? phoneNumber = null, RegistrationState? state = null, CancellationToken cancellationToken = default)
        {
            var session = await dbContext.TelegramUserSessions
                    .FirstOrDefaultAsync(s => s.TelegramUserId == telegramId, cancellationToken: cancellationToken);

            if (session == null)
            {
                session = new TelegramUserSession
                {
                    TelegramUserId = telegramId,
                    PhoneNumber = phoneNumber,
                    State = state ?? RegistrationState.None
                };
                await dbContext.TelegramUserSessions.AddAsync(session, cancellationToken);
            }
            else
            {
                if (!string.IsNullOrEmpty(phoneNumber))
                    session.PhoneNumber = phoneNumber;

                if (state.HasValue)
                    session.State = state.Value;

                session.LastActivity = DateTime.UtcNow;
                dbContext.TelegramUserSessions.Update(session);
            }

            await dbContext.SaveChangesAsync(cancellationToken);
        }

        public async Task<bool> IsPhoneNumberRegisteredAsync(string phoneNumber, CancellationToken cancellationToken = default)
            => await dbContext.Users.AsNoTracking().AnyAsync(u => u.PhoneNumber == phoneNumber, cancellationToken);

        public async Task<TelegramUserSession?> GetSessionAsync(long telegramUserId, CancellationToken cancellationToken = default)
            => await dbContext.TelegramUserSessions
                .AsNoTracking()
                .FirstOrDefaultAsync(cancellationToken: cancellationToken);

        public string GetLoginLinkAsync()
        {
            var baseUrl = configuration["Website:BaseUrl"] ?? throw new ArgumentNullException("");

            return $"{baseUrl}/auth";
        }

        public async Task<bool> IsUserRegisteredByTelegramIdAsync(long telegramId, CancellationToken cancellationToken = default)
            => await dbContext.Users.AsNoTracking().AnyAsync(u => u.TelegramId == telegramId, cancellationToken);

        public async Task<LoginResult> Login(string phoneNumber, string password, string device = "Unknow", CancellationToken cancellationToken = default)
        {
            var user = await dbContext.Users.FirstOrDefaultAsync(u => u.PhoneNumber == phoneNumber, cancellationToken);
            var loginResult = new LoginResult();

            if (user == null || !hasher.VerifyPassword(password, user.PasswordHash))
            {
                loginResult.IsFailure("Неверный логин или пароль.");
                return loginResult;
            }
            else
            {
                var accessToken = tokenService.GenerateAccessToken(user.Id.ToString(), user.PhoneNumber!);
                var (RefreshToken, ExpiresAt) = tokenService.GenerateRefreshToken();
                var refreshToken = new RefreshToken()
                {
                    TokenHash = hasher.HashRefreshToken(RefreshToken),
                    ExpiresAt = ExpiresAt,
                    Device = device,
                };

                user.RefreshTokens.Add(refreshToken);
                await dbContext.SaveChangesAsync(cancellationToken);

                loginResult.IsSuccess(accessToken, RefreshToken);
                return loginResult;
            }
        }
    }
    public class LoginResult
    {
        public string? AccessToken { get; private set; } 

        public string? RefreshToken { get; private set; } 

        public bool IsSuccessful { get; private set; }

        public string? ErrorMessage { get; private set; }

        public void IsSuccess(string accessToken, string refreshToken)
        {
            AccessToken = accessToken;
            RefreshToken = refreshToken;
            IsSuccessful = true;
        }
        public void IsFailure(string errorMessage)
        {
            ErrorMessage = errorMessage;
            IsSuccessful = false;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Implementations\Hasher.cs =====

using Lemmo.WebApi.Persistance.Auth.Interfaces;

namespace Lemmo.WebApi.Persistance.Auth.Implementations
{
    public class Hasher : IHasher
    {
        public string HashPassword(string password) =>
            BCrypt.Net.BCrypt.HashPassword(password);

        public bool VerifyPassword(string password, string hashedPassword) =>
            BCrypt.Net.BCrypt.Verify(password, hashedPassword);

        public string HashRefreshToken(string refreshToken) =>
            BCrypt.Net.BCrypt.HashPassword(refreshToken);

        public bool VerifyRefreshToken(string hashedRrefreshToken, string refreshToken) =>
            BCrypt.Net.BCrypt.Verify(refreshToken, hashedRrefreshToken);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Implementations\JwtService.cs =====

using Lemmo.WebApi.Persistance.Auth.Interfaces;
using Microsoft.IdentityModel.Tokens;
using System.IdentityModel.Tokens.Jwt;
using System.Security.Claims;
using System.Security.Cryptography;
using System.Text;

namespace Lemmo.WebApi.Persistance.Auth.Implementations
{
    public class JwtTokenService(IConfiguration config) : ITokenService
    {
        public string GenerateAccessToken(string userId, string phoneNumber)
        {
            var jwt = config.GetSection("Jwt");

            var claims = new[]
            {
                new Claim(ClaimTypes.NameIdentifier, userId),
                new Claim(ClaimTypes.MobilePhone, phoneNumber)
            };

            var key = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(jwt["Key"]!));

            var token = new JwtSecurityToken(
                issuer: jwt["Issuer"],
                audience: jwt["Audience"],
                claims: claims,
                expires: DateTime.UtcNow.AddMinutes(int.Parse(jwt["AccessExpiresMinutes"]!)),
                signingCredentials: new SigningCredentials(key, SecurityAlgorithms.HmacSha256)
            );

            return new JwtSecurityTokenHandler().WriteToken(token);
        }

        public (string Token, DateTime ExpiresAt) GenerateRefreshToken()
        {
            var bytes = RandomNumberGenerator.GetBytes(64);

            string token = Convert.ToBase64String(bytes);
            DateTime expiresAt = DateTime.UtcNow.AddDays(int.Parse(config["Jwt:RefreshExpiresDays"]!));

            return (token, expiresAt);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Implementations\TelegramSessionService.cs =====

using Lemmo.WebApi.Infrastructure.Data;
using Microsoft.EntityFrameworkCore;

namespace Lemmo.WebApi.Persistance.Auth.Implementations
{
    public class TelegramSessionService(ApplicationDbContext context, ILogger<TelegramSessionService> logger)
    {

        public async Task CleanupExpiredSessionsAsync(TimeSpan expirationTime)
        {
            var expirationDate = DateTime.UtcNow - expirationTime;

            var expiredSessions = await context.TelegramUserSessions
                .Where(s => s.LastActivity < expirationDate)
                .ToListAsync();

            if (expiredSessions.Count > 0)
            {
                context.TelegramUserSessions.RemoveRange(expiredSessions);
                await context.SaveChangesAsync();

                logger.LogInformation("Удалено {Count} просроченных сессий", expiredSessions.Count);
            }
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Interfaces\IAuthManager.cs =====

using Lemmo.WebApi.Entitys.TelegramSessions;
using Lemmo.WebApi.Entitys.TelegramSessions.Enums;
using Lemmo.WebApi.Persistance.Auth.Implementations;

namespace Lemmo.WebApi.Persistance.Auth.Interfaces
{
    public interface IAuthManager
    {
        Task CreateAccount(string phoneNumber, string password, long telegramId, CancellationToken cancellationToken = default);

        Task CreateOrUpdateTelegramSessionAsync(long telegramId, string? phoneNumber = null, RegistrationState? state = null, CancellationToken cancellationToken = default);

        Task<TelegramUserSession?> GetSessionAsync(long telegramUserId, CancellationToken cancellationToken = default);

        string GetLoginLinkAsync();

        Task<bool> IsUserRegisteredByTelegramIdAsync(long telegramId, CancellationToken cancellationToken = default);

        Task<bool> IsPhoneNumberRegisteredAsync(string phoneNumber, CancellationToken cancellationToken = default);

        Task DeleteTelegramSessionAsync(long telegramId, CancellationToken cancellationToken = default);

        Task<LoginResult> Login(string phoneNumber, string password, string device = "Unknow", CancellationToken cancellationToken = default);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Interfaces\IHasher.cs =====

namespace Lemmo.WebApi.Persistance.Auth.Interfaces
{
    public interface IHasher
    {
        string HashPassword(string password);

        bool VerifyPassword(string password, string hashedPassword);

        string HashRefreshToken(string refreshToken);

        bool VerifyRefreshToken(string hashedRrefreshToken, string refreshToken);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\Interfaces\ITokenService.cs =====

namespace Lemmo.WebApi.Persistance.Auth.Interfaces
{
    public interface ITokenService
    {
        string GenerateAccessToken(string userId, string phoneNumber);

        (string Token, DateTime ExpiresAt) GenerateRefreshToken();
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\Auth\AuthExtentions.cs =====

using Lemmo.WebApi.Persistance.Auth.Implementations;
using Lemmo.WebApi.Persistance.Auth.Interfaces;
using Microsoft.AspNetCore.Authentication.JwtBearer;
using Microsoft.IdentityModel.Tokens;
using System.Text;

namespace Lemmo.WebApi.Persistance.Auth
{
    public static class AuthExtentions
    {
        public static IServiceCollection AddAuth(this IServiceCollection services, IConfiguration configuration)
        {
            services.AddAuthentication(options =>
            {
                options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
                options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
                options.DefaultScheme = JwtBearerDefaults.AuthenticationScheme;
            })
            .AddJwtBearer(options =>
            {
                options.TokenValidationParameters = new TokenValidationParameters
                {
                    ValidateIssuer = true,
                    ValidateAudience = true,
                    ValidateLifetime = true,
                    ValidateIssuerSigningKey = true,
                    ValidIssuer = configuration["Jwt:Issuer"],
                    ValidAudience = configuration["Jwt:Audience"],
                    IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(configuration["Jwt:Key"]!))
                };
            });

            services.AddScoped<ITokenService, JwtTokenService>();

            services.AddScoped<IHasher, Hasher>();

            services.AddScoped<IAuthManager, AuthManager>();

            services.AddAuthorization();
            return services;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Interfaces\ITelegramBotService.cs =====

namespace Lemmo.WebApi.Persistance.TelegramBot.Interfaces
{
    public interface ITelegramBotService
    {
        Task StartAsync(CancellationToken cancellationToken);
        Task StopAsync(CancellationToken cancellationToken);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Interfaces\ITelegramMessageHandler.cs =====

using Telegram.Bot;
using Telegram.Bot.Types;

namespace Lemmo.WebApi.Persistance.TelegramBot.Interfaces
{
    public interface ITelegramMessageHandler
    {
        Task HandleMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Interfaces\ITelegramRegistrationService.cs =====

using Telegram.Bot;
using Telegram.Bot.Types;

namespace Lemmo.WebApi.Persistance.TelegramBot.Interfaces
{
    public interface ITelegramRegistrationService
    {
        Task StartRegistrationAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken);
        Task ProcessMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken);
        Task CompleteRegistrationAsync(ITelegramBotClient botClient, long telegramId, string phoneNumber, string password, long chatId, CancellationToken cancellationToken);
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Interfaces\ITelegramUpdateHandler.cs =====

using Telegram.Bot.Polling;

namespace Lemmo.WebApi.Persistance.TelegramBot.Interfaces
{
    public interface ITelegramUpdateHandler : IUpdateHandler
    {
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Services\RegistrationTelegramService.cs =====

using Lemmo.WebApi.Entitys.TelegramSessions;
using Lemmo.WebApi.Entitys.TelegramSessions.Enums;
using Lemmo.WebApi.Persistance.Auth.Interfaces;
using Lemmo.WebApi.Persistance.TelegramBot.Interfaces;
using System.Text.RegularExpressions;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Bot.Types.ReplyMarkups;

namespace Lemmo.WebApi.Persistance.TelegramBot.Services
{
    public class RegistrationTelegramService(IServiceScopeFactory scopeFactory) : ITelegramRegistrationService
    {
        //++
        public async Task StartRegistrationAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
        try
        {
                var telegramId = message.From!.Id;

                using var scope = scopeFactory.CreateScope();

                var authManager = scope.ServiceProvider.GetRequiredService<IAuthManager>();

                var isAlreadyRegistered = await authManager.IsUserRegisteredByTelegramIdAsync(telegramId, cancellationToken);

                if (isAlreadyRegistered)
                {
                    await botClient.SendMessage(
                        chatId: message.Chat.Id,
                        text: "Вы уже зарегистрированы!",
                        cancellationToken: cancellationToken
                    );
                    return;
                }

                await authManager.CreateOrUpdateTelegramSessionAsync(
                    telegramId: telegramId,
                    state: RegistrationState.WaitingForPhone,
                    cancellationToken: cancellationToken);

                var keyboard = new ReplyKeyboardMarkup(
                [
                    [KeyboardButton.WithRequestContact("?? Поделиться номером телефона")]
                ])
                {
                    ResizeKeyboard = true,
                    OneTimeKeyboard = true
                };

                await botClient.SendMessage(
                    chatId: message.Chat.Id,
                    text: "?? Регистрация\n\nПожалуйста, поделитесь вашим номером телефона, нажав кнопку ниже.",
                    replyMarkup: keyboard,
                    cancellationToken: cancellationToken
                );
            }
           catch(Exception ex){
                Console.WriteLine(ex);
           }
        }

        public async Task ProcessMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            await TryDeleteMessageAsync(botClient, message.Chat.Id, message.MessageId, cancellationToken);

            var telergramId = message.From!.Id;

            using var scope = scopeFactory.CreateScope();

            var authManager = scope.ServiceProvider.GetRequiredService<IAuthManager>();

            var session = await authManager.GetSessionAsync(telergramId, cancellationToken);

            if (session == null)
            {
                return;
            }

            if (session.State == RegistrationState.WaitingForPhone)
            {
                await ProcessPhoneInputAsync(botClient, message, session, cancellationToken);
            }
            else if (session.State == RegistrationState.WaitingForPassword)
            {
                await ProcessPasswordInputAsync(botClient, message, session, cancellationToken);
            }
        }

        private async Task ProcessPhoneInputAsync(ITelegramBotClient botClient, Message message, TelegramUserSession session, CancellationToken cancellationToken)
        {
            var phoneNumber = ExtractPhoneNumber(message);

            if (!IsValidPhoneNumber(phoneNumber))
            {
                await botClient.SendMessage(
                    chatId: message.Chat.Id,
                    text: "? Неверный формат номера телефона.",
                    cancellationToken: cancellationToken
                );
                return;
            }

            using var scope = scopeFactory.CreateScope();
            var authManager = scope.ServiceProvider.GetRequiredService<IAuthManager>();

            var isPhoneTaken = await authManager.IsPhoneNumberRegisteredAsync(phoneNumber, cancellationToken);

            if (isPhoneTaken)
            {
                await botClient.SendMessage(
                    chatId: message.Chat.Id,
                    text: "? Этот номер телефона уже зарегистрирован.",
                    cancellationToken: cancellationToken
                );

                await authManager.DeleteTelegramSessionAsync(session.TelegramUserId, cancellationToken);
                return;
            }

            await authManager.CreateOrUpdateTelegramSessionAsync(
                session.TelegramUserId,
                phoneNumber: phoneNumber,
                state: RegistrationState.WaitingForPassword,
                cancellationToken: cancellationToken);

            await botClient.SendMessage(
                chatId: message.Chat.Id,
                text: $"? Номер принят: {phoneNumber}\n\n" +
                      "Теперь придумайте и введите пароль (минимум 6 символов)",
                replyMarkup: new ReplyKeyboardRemove(),
                cancellationToken: cancellationToken
            );
        }

        private async Task ProcessPasswordInputAsync(ITelegramBotClient botClient, Message message, TelegramUserSession session, CancellationToken cancellationToken)
        {
            if (string.IsNullOrEmpty(message.Text))
            {
                await botClient.SendMessage(
                    chatId: message.Chat.Id,
                    text: "? Пожалуйста, введите пароль.",
                    cancellationToken: cancellationToken
                );
                return;
            }

            var password = message.Text.Trim();

            if (password.Length < 6)
            {
                await botClient.SendMessage(
                    chatId: message.Chat.Id,
                    text: "? Пароль должен содержать минимум 6 символов.",
                    cancellationToken: cancellationToken
                );
                return;
            }

            await CompleteRegistrationAsync(botClient, session.TelegramUserId, session.PhoneNumber!, password, message.Chat.Id, cancellationToken);
        }

        public async Task CompleteRegistrationAsync(ITelegramBotClient botClient, long telegramId, string phoneNumber, string password, long chatId, CancellationToken cancellationToken)
        {
            using var scope = scopeFactory.CreateScope();
            var authManager = scope.ServiceProvider.GetRequiredService<IAuthManager>();

            await authManager.CreateAccount(phoneNumber, password, telegramId, cancellationToken);

            var authLink = authManager.GetLoginLinkAsync();

            // Отправляем сообщение с кнопкой
            var inlineKeyboard = new InlineKeyboardMarkup(
            [
                [
                    InlineKeyboardButton.WithUrl("?? Перейти на сайт", authLink)
                ]
            ]);

            await botClient.SendMessage(
                chatId: chatId,
                text: $"?? Регистрация успешно завершена!\n\n" +
                      $"Нажмите кнопку ниже для перехода на сайт.",
                replyMarkup: inlineKeyboard,
                cancellationToken: cancellationToken
            );
        }

        private string? ExtractPhoneNumber(Message message) => message.Contact?.PhoneNumber ?? message.Text?.Trim();

        private bool IsValidPhoneNumber(string? phone)
        {
            if (string.IsNullOrWhiteSpace(phone)) return false;

            var cleanPhone = Regex.Replace(phone, @"[^\d+]", "");

            if (cleanPhone.StartsWith("+380") && cleanPhone.Length == 13) return true;
            if (cleanPhone.StartsWith("380") && cleanPhone.Length == 12) return true;
            if (cleanPhone.StartsWith("0") && cleanPhone.Length == 10) return true;
            if (cleanPhone.StartsWith("80") && cleanPhone.Length == 11) return true;

            return false;
        }

        private async Task<bool> TryDeleteMessageAsync(ITelegramBotClient botClient, long chatId, int messageId, CancellationToken cancellationToken)
        {
            try
            {
                await botClient.DeleteMessage(
                    chatId: chatId,
                    messageId: messageId,
                    cancellationToken: cancellationToken
                );
                return true;
            }
            catch (Exception ex)
            {
                return false;
            }
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Services\TelegramBotHostedService.cs =====

using Lemmo.WebApi.Persistance.TelegramBot.Interfaces;
using Telegram.Bot;
using Telegram.Bot.Polling;

namespace Lemmo.WebApi.Persistance.TelegramBot.Services
{
    public class TelegramBotHostedService(ITelegramBotClient botClient, ITelegramUpdateHandler updateHandler, ILogger<TelegramBotHostedService> logger) : IHostedService
    {
        private CancellationTokenSource _cts = new();

        public Task StartAsync(CancellationToken cancellationToken)
        {
            var receiverOptions = new ReceiverOptions
            {
                AllowedUpdates = [],
            };

            _ = Task.Run(async () =>
            {
                try
                {
                    await botClient.ReceiveAsync(
                        updateHandler: updateHandler,
                        receiverOptions: receiverOptions,
                        cancellationToken: _cts.Token
                    );
                }
                catch (OperationCanceledException) when (_cts.IsCancellationRequested)
                {
                }
                catch (Exception ex)
                {
                    logger.LogError(ex, "Ошибка в ReceiveAsync");
                }
            }, cancellationToken);

            logger.LogInformation("Telegram бот запущен");
            return Task.CompletedTask;
        }

        public Task StopAsync(CancellationToken cancellationToken)
        {
            _cts.Cancel();
            logger.LogInformation("Telegram бот остановлен");
            return Task.CompletedTask;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Services\TelegramMessageHandler.cs =====

using Lemmo.WebApi.Persistance.Auth.Interfaces;
using Lemmo.WebApi.Persistance.TelegramBot.Interfaces;
using Telegram.Bot;
using Telegram.Bot.Types;
using Telegram.Bot.Types.ReplyMarkups;

namespace Lemmo.WebApi.Persistance.TelegramBot.Services
{
    public class TelegramMessageHandler(IServiceProvider serviceProvider) : ITelegramMessageHandler
    {
        //++
        public async Task HandleMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            if (message.From == null) return;

            if (message.Text == "/start")
            {
                await HandleStartCommandAsync(botClient, message, cancellationToken);
            }
            else if (message.Text == "register_command")
            {
                await HandleRegisterCallbackAsync(botClient, message, cancellationToken);
            }
            else
            {
                using var scope = serviceProvider.CreateScope();
                var registrationService = scope.ServiceProvider.GetRequiredService<ITelegramRegistrationService>();
                await registrationService.ProcessMessageAsync(botClient, message, cancellationToken);
            }
        }

        //++
        private async Task HandleStartCommandAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            using var scope = serviceProvider.CreateScope();
            var authManager = scope.ServiceProvider.GetRequiredService<IAuthManager>();

            var telegramId = message.From!.Id;
            var isRegistered = await authManager.IsUserRegisteredByTelegramIdAsync(telegramId, cancellationToken);

            string response;
            InlineKeyboardMarkup inlineKeyboard;

            if (isRegistered)
            {
                response = $"?? С возвращением, {message.From.FirstName}!\n" +
                          "Вы уже зарегистрированы в системе.";
                var loginLink = authManager.GetLoginLinkAsync();

                inlineKeyboard = new InlineKeyboardMarkup(
                [
                    [
                        InlineKeyboardButton.WithCallbackData("?? Перейти на сайт", loginLink)
                    ],
                    [
                        InlineKeyboardButton.WithCallbackData("?? Забыли пароль?", loginLink)
                    ],
                    [
                        InlineKeyboardButton.WithCallbackData("!? Выход на всех устройствах", loginLink)
                    ],
                ]);
            }
            else
            {
                response = $"?? Привет, {message.From.FirstName}!\n\n" +
                          "Я бот для регистрации в Lemmo.\n\n" +
                          "Нажмите кнопку ниже, чтобы начать регистрацию.";

                inlineKeyboard = new InlineKeyboardMarkup(
                [
                    [
                        InlineKeyboardButton.WithCallbackData("?? Зарегистрироваться", "register_command")
                    ]
                ]);
            }

            await botClient.SendMessage(
                chatId: message.Chat.Id,
                text: response,
                replyMarkup: inlineKeyboard,
                cancellationToken: cancellationToken
            );
        }

        //++
        private async Task HandleRegisterCallbackAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            using var scope = serviceProvider.CreateScope();
            var registrationService = scope.ServiceProvider.GetRequiredService<ITelegramRegistrationService>();
            await registrationService.StartRegistrationAsync(botClient, message, cancellationToken);
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\Services\TelegramUpdateHandler.cs =====

using Lemmo.WebApi.Persistance.TelegramBot.Interfaces;
using Telegram.Bot;
using Telegram.Bot.Polling;
using Telegram.Bot.Types;
using Telegram.Bot.Types.Enums;

namespace Lemmo.WebApi.Persistance.TelegramBot.Services
{
    public class TelegramUpdateHandler(IServiceScopeFactory scopeFactory, ILogger<TelegramUpdateHandler> logger) : ITelegramUpdateHandler
    {
        public async Task HandleUpdateAsync(ITelegramBotClient botClient, Update update, CancellationToken cancellationToken)
        {
            try
            {
                switch (update.Type)
                {
                    case UpdateType.Message:
                        await HandleMessageAsync(botClient, update.Message!, cancellationToken);
                        break;
                    case UpdateType.CallbackQuery:
                        await HandleCallbackQueryAsync(botClient, update.CallbackQuery!, cancellationToken);
                        break;
                    default:
                        logger.LogDebug("Необработанный тип обновления: {UpdateType}", update.Type);
                        break;
                }
            }
            catch (Exception ex)
            {
                logger.LogError(ex, "Ошибка обработки обновления типа {UpdateType}", update.Type);
            }
        }

        public Task HandlePollingErrorAsync(ITelegramBotClient botClient, Exception exception, CancellationToken cancellationToken)
        {
            logger.LogError(exception, "Ошибка при опросе Telegram");
            return Task.CompletedTask;
        }

        private async Task HandleMessageAsync(ITelegramBotClient botClient, Message message, CancellationToken cancellationToken)
        {
            using var scope = scopeFactory.CreateScope();
            var messageHandler = scope.ServiceProvider.GetRequiredService<ITelegramMessageHandler>();
            await messageHandler.HandleMessageAsync(botClient, message, cancellationToken);
        }

        private async Task HandleCallbackQueryAsync(ITelegramBotClient botClient, CallbackQuery callbackQuery, CancellationToken cancellationToken)
        {
            logger.LogInformation("Получен CallbackQuery от пользователя {UserId}: {Data}",
                callbackQuery.From.Id, callbackQuery.Data);

            try
            {
                if (callbackQuery.Message != null)
                {
                    await botClient.EditMessageReplyMarkup(
                        chatId: callbackQuery.Message.Chat.Id,
                        messageId: callbackQuery.Message.MessageId,
                        replyMarkup: null,
                        cancellationToken: cancellationToken
                    );
                }
            }
            catch (Exception ex)
            {
                logger.LogWarning(ex, "Не удалось обновить reply markup");
            }

            using var scope = scopeFactory.CreateScope();
            var messageHandler = scope.ServiceProvider.GetRequiredService<ITelegramMessageHandler>();

            var message = new Message
            {
                From = callbackQuery.From,
                Chat = callbackQuery.Message?.Chat ?? new Chat { Id = callbackQuery.From.Id },
                Text = callbackQuery.Data
            };

            await messageHandler.HandleMessageAsync(botClient, message, cancellationToken);

            await botClient.AnswerCallbackQuery(
                callbackQueryId: callbackQuery.Id,
                cancellationToken: cancellationToken
            );
        }

        public Task HandleErrorAsync(ITelegramBotClient botClient, Exception exception, HandleErrorSource source, CancellationToken cancellationToken) 
            => throw new NotImplementedException();
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Persistance\TelegramBot\TelegramBotExtentions.cs =====

using Lemmo.WebApi.Persistance.TelegramBot.Interfaces;
using Lemmo.WebApi.Persistance.TelegramBot.Services;
using Telegram.Bot;

namespace Lemmo.WebApi.Persistance.TelegramBot
{
    public static class ServiceCollectionExtensions
    {
        public static IServiceCollection AddTelegramBot(this IServiceCollection services, IConfiguration configuration)
        {
            // Telegram Bot Client
            services.AddSingleton<ITelegramBotClient>(sp =>
            {
                var token = configuration["TelegramBot:Token"];
                if (string.IsNullOrEmpty(token))
                    throw new InvalidOperationException("Telegram Bot Token не настроен");

                return new TelegramBotClient(token);
            });

            // Сервисы
            services.AddScoped<ITelegramMessageHandler, TelegramMessageHandler>();
            services.AddScoped<ITelegramRegistrationService, RegistrationTelegramService>();

            // Обработчики
            services.AddSingleton<ITelegramUpdateHandler, TelegramUpdateHandler>();

            // Hosted Service
            services.AddHostedService<TelegramBotHostedService>();

            return services;
        }
    }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Properties\launchSettings.json =====

{
  "$schema": "http://json.schemastore.org/launchsettings.json",
  "iisSettings": {
    "windowsAuthentication": false,
    "anonymousAuthentication": true,
    "iisExpress": {
      "applicationUrl": "http://localhost:40904",
      "sslPort": 44326
    }
  },
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "http://localhost:5282",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "https": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "launchBrowser": true,
      "launchUrl": "swagger",
      "applicationUrl": "https://localhost:7268;http://localhost:5282",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    },
    "IIS Express": {
      "commandName": "IISExpress",
      "launchBrowser": true,
      "launchUrl": "swagger",
      "environmentVariables": {
        "ASPNETCORE_ENVIRONMENT": "Development"
      }
    }
  }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\appsettings.Development.json =====

{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\appsettings.json =====

{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },

  "AllowedHosts": "*",

  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Port=5432;Database=lemmoDb;Username=postgres;Password=H78_hje76;Include Error Detail=true"
  },

  "TelegramBot": {
    "Token": "8460507228:AAE20HEb5HIWNVdYEBWs3FgNG7uCN89dIF0"
  },
  "Jwt": {
    "Key": "x5JVhYFxi6R3rhj162MYJF7e6AR4HyG3IDpUUW3P7iP",
    "Issuer": "LemmoApi",
    "Audience": "LemmoClient",
    "AccessExpiresMinutes": 15,
    "RefreshExpiresDays": 30
  },
  "Website": {
    "BaseUrl": "https://yourwebsite.com"
  }
}



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Lemmo.WebApi.csproj =====

<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="BCrypt.Net-Next" Version="4.0.3" />
    <PackageReference Include="FluentValidation" Version="12.1.1" />
    <PackageReference Include="FluentValidation.DependencyInjectionExtensions" Version="12.1.1" />
    <PackageReference Include="MediatR" Version="14.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.22" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.22">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.11" />
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.6.2" />
    <PackageReference Include="Telegram.Bot" Version="22.7.6" />
  </ItemGroup>

</Project>



===== FILE: C:\Users\User\Desktop\ываыва\Lemmo\Lemmo.WebApi\Program.cs =====

using Lemmo.WebApi.Application;
using Lemmo.WebApi.Infrastructure.Data;
using Lemmo.WebApi.Persistance.Auth;
using Lemmo.WebApi.Persistance.TelegramBot;

internal class Program
{
    private static void Main(string[] args)
    {
        var builder = WebApplication.CreateBuilder(args);

        builder.Services.AddControllers();
        builder.Services.AddEndpointsApiExplorer();
        builder.Services.AddSwaggerGen();

        builder.Services.AddAppDB(builder.Configuration);

        builder.Services.AddAuth(builder.Configuration);

        // Регистрация сервисов Telegram бота
        builder.Services.AddTelegramBot(builder.Configuration);
        builder.Services.AddMediator();
        var app = builder.Build();

        app.ApplyMigrations();

        // Configure the HTTP request pipeline.
        if (app.Environment.IsDevelopment())
        {
            app.UseSwagger();
            app.UseSwaggerUI();
        }

        app.UseHttpsRedirection();

        app.UseAuthorization();

        app.MapControllers();

        app.Run();

    }
}


